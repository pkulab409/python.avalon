{% extends "base.html" %}
{% block title %}
    游戏大厅 - 游戏平台
{% endblock title %}
{% block content %}
    <style>
  /* 原有样式保留 */
  
  /* 新增压缩布局样式 */
  .compact-card .card-header {
    padding: 0.5rem 1rem;
  }
  
  .compact-card .card-header h5 {
    font-size: 0.95rem;
    margin-bottom: 0;
  }
  
  .compact-card .card-body {
    padding: 0.75rem;
  }
  
  .stats-container .p-3 {
    padding: 0.5rem !important;
  }
  
  .stats-container h3 {
    font-size: 1.5rem;
    margin-bottom: 0.2rem;
  }
  
  .stats-container .small {
    font-size: 0.7rem;
  }
  
  .filter-form .form-label {
    margin-bottom: 0.25rem;
    font-size: 0.8rem;
  }
  
  .filter-form .form-control,
  .filter-form .form-select {
    margin-bottom: 0.5rem;
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    height: calc(1.5em + 0.5rem + 2px);
  }
  
  /* 添加用户按钮圆形样式 */
  #addPlayerBtn {
    border-radius: 50%;
    width: 32px;
    height: 32px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 10px;
    position: relative;
    right: -10px;
  }
  
  /* 状态标签样式 */
  .badge {
    padding: 0.35em 0.65em;
    border-radius: 0.25rem;
    font-weight: 500;
    font-size: 0.75rem;
    display: inline-block;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
  }
  
  .status-completed {
    background-color: #28a745;
    color: white;
  }
  
  .status-playing {
    background-color: #007bff;
    color: white;
  }
  
  .status-waiting {
    background-color: #ffc107;
    color: #212529;
  }
  
  .status-error {
    background-color: #dc3545;
    color: white;
  }
  
  .status-cancelled {
    background-color: #6c757d;
    color: white;
  }
  
  /* 筛选按钮圆形样式 */
  .filter-btn {
    border-radius: 50%;
    width: 48px;
    height: 48px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
    transition: all 0.2s ease;
    margin: 0 auto;
    margin-top: 18px;
  }
  
  .filter-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 0 15px rgba(0, 123, 255, 0.7);
  }
  
  .filter-btn i {
    font-size: 1.2rem;
  }
  
  .player-tags-container {
    min-height: 32px;
    padding: 4px;
  }
  
  /* 两栏布局样式，将统计数据改为两列 */
  @media (min-width: 768px) {
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
    }
  }
    </style>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>
                <i class="bi bi-controller me-2"></i>游戏大厅
            </h2>
            <a href="{{ url_for('game.create_battle_page') }}"
               class="btn btn-primary create-battle-btn">
                <i class="bi bi-plus-circle me-1"></i> 创建对战
            </a>
        </div>
        <!-- 对战统计卡片 - 添加compact-card类 -->
        <div class="card shadow-sm mb-3 compact-card">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up me-2"></i>对战统计
                    <button id="refreshStatsBtn"
                            class="btn btn-sm btn-outline-secondary float-end">
                        <i class="bi bi-arrow-repeat"></i> 刷新
                    </button>
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- 这里将由AJAX动态填充内容 -->
                    <div class="col-12 text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="mt-2 text-muted">正在加载统计数据...</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- 筛选对战卡片 - 添加compact-card类 -->
        <div class="card shadow-sm mb-3 compact-card">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="bi bi-funnel me-2"></i>筛选对战
                </h5>
            </div>
            <div class="card-body">
                <form method="GET"
                      action="{{ url_for('game.lobby') }}"
                      class="filter-form"
                      id="battleFilterForm">
                    <div class="row g-2">
                        <div class="col-lg-2 col-md-4 col-sm-6">
                            <label for="date_from" class="form-label">开始日期:</label>
                            <input type="date"
                                   id="date_from"
                                   name="date_from"
                                   class="form-control form-control-sm"
                                   value="{{ current_filters.date_from or '' }}">
                        </div>
                        <div class="col-lg-2 col-md-4 col-sm-6">
                            <label for="date_to" class="form-label">结束日期:</label>
                            <input type="date"
                                   id="date_to"
                                   name="date_to"
                                   class="form-control form-control-sm"
                                   value="{{ current_filters.date_to or '' }}">
                        </div>
                        <div class="col-lg-2 col-md-4 col-sm-6">
                            <label for="status" class="form-label">状态:</label>
                            <select id="status" name="status" class="form-select form-select-sm">
                                <option value="all"
                                        {% if not current_filters.status or current_filters.status == 'all' %}selected{% endif %}>
                                    所有状态
                                </option>
                                <option value="waiting"
                                        {% if current_filters.status == 'waiting' %}selected{% endif %}>等待中</option>
                                <option value="playing"
                                        {% if current_filters.status == 'playing' %}selected{% endif %}>进行中</option>
                                <option value="completed"
                                        {% if current_filters.status == 'completed' %}selected{% endif %}>已完成</option>
                                <option value="error"
                                        {% if current_filters.status == 'error' %}selected{% endif %}>错误</option>
                                <option value="cancelled"
                                        {% if current_filters.status == 'cancelled' %}selected{% endif %}>已取消</option>
                            </select>
                        </div>
                        <div class="col-lg-4 col-md-8 col-sm-12">
                            <label for="player_input" class="form-label">玩家 (最多7位):</label>
                            <div class="player-selector">
                                <div class="input-group input-group-sm mb-1">
                                    <input type="text"
                                           id="player_input"
                                           class="form-control"
                                           list="player-list"
                                           placeholder="输入用户名或ID后按Enter添加"
                                           aria-label="玩家用户名"
                                           aria-describedby="addPlayerBtn">
                                    <button type="button"
                                            id="addPlayerBtn"
                                            class="btn btn-outline-secondary"
                                            title="添加玩家">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                                {% if all_users %}
                                    <datalist id="player-list">
                                        {% for user in all_users %}<option value="{{ user.username }}">{{ user.username }}</option>{% endfor %}
                                    </datalist>
                                {% endif %}
                                <!-- Player tags container -->
                                <div class="player-tags-container" id="playerTagsContainer">
                                    {% if current_filters.players %}
                                        {% for player in current_filters.players %}
                                            <div class="player-tag">
                                                {{ player }}
                                                <span class="remove-tag" data-player="{{ player }}" title="移除">×</span>
                                                <input type="hidden" name="players" value="{{ player }}">
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-4 col-sm-6 btn-submit-row">
                            <button type="submit" class="btn btn-primary filter-btn">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>对战列表
                    <button id="refreshListBtn"
                            class="btn btn-sm btn-outline-secondary float-end">
                        <i class="bi bi-arrow-repeat"></i> 刷新
                    </button>
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0 battle-table"
                           id="battlesTable">
                        <thead class="table-light">
                            <tr>
                                <th scope="col" width="15%">对战ID</th>
                                <th scope="col" width="15%">状态</th>
                                <th scope="col" width="10%">类型</th>
                                {# 新增类型列 #}
                                <th scope="col" width="20%">创建时间</th>
                                <th scope="col" width="20%">结束时间</th>
                                <th scope="col" width="20%">操作</th>
                                {# 调整宽度以适应新列 #}
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 懒加载提示 -->
                            {% if battles_pagination and battles_pagination.total > 20 %}
                                <tr id="lazyLoadRow" class="text-center">
                                    <td colspan="6" class="py-3">
                                        <small class="text-muted">优化显示中 - 已加载 {{ battles_pagination.items|length }} 条记录 (共 {{ battles_pagination.total }})</small>
                                    </td>
                                </tr>
                            {% endif %}
                            {% if battles_pagination and battles_pagination.items %}
                                {% for battle in battles_pagination.items %}
                                    <tr class="battle-card">
                                        <td>
                                            <a href="{{ url_for('game.view_battle', battle_id=battle.id) }}"
                                               class="battle-id text-decoration-none">{{ battle.id[:8] }}...</a>
                                        </td>
                                        <td>
                                            {% if battle.status == 'completed' %}
                                                <span class="badge status-completed">已完成</span>
                                            {% elif battle.status == 'playing' %}
                                                <span class="badge status-playing">进行中</span>
                                            {% elif battle.status == 'waiting' %}
                                                <span class="badge status-waiting">等待中</span>
                                            {% elif battle.status == 'error' %}
                                                <span class="badge status-error">错误</span>
                                            {% elif battle.status == 'cancelled' %}
                                                <span class="badge status-cancelled">已取消</span>
                                            {% else %}
                                                <span class="badge bg-light text-dark">{{ battle.status }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {# 显示对战类型 #}
                                            {% if battle.battle_type == 'ai_series_test' %}
                                                <span class="badge bg-secondary"
                                                      data-bs-toggle="tooltip"
                                                      title="AI系列位置测试赛 (不计ELO)">系列测试</span>
                                            {% elif battle.is_elo_exempt %}
                                                <span class="badge bg-light text-dark"
                                                      data-bs-toggle="tooltip"
                                                      title="此对战不计入ELO/统计">豁免赛</span>
                                            {% else %}
                                                {% if battle.ranking_id == 0 %}
                                                    <span class="badge bg-info">测试赛</span>
                                                {% elif 1 <= battle.ranking_id <= 10 %}
                                                    <span class="badge bg-info">初赛</span>
                                                {% elif 11 <= battle.ranking_id <= 20 %}
                                                    <span class="badge bg-info">半决赛</span>
                                                {% elif 21 <= battle.ranking_id <= 30 %}
                                                    <span class="badge bg-info">决赛</span>
                                                {% else %}
                                                    <span class="badge bg-info">标准赛</span>
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                        <td>{{ battle.created_at.strftime("%Y-%m-%d %H:%M") if battle.created_at else '-' }}</td>
                                        <td>{{ battle.ended_at.strftime("%Y-%m-%d %H:%M") if battle.ended_at else '-' }}</td>
                                        <td>
                                            <a href="{{ url_for('game.view_battle', battle_id=battle.id) }}"
                                               class="btn btn-sm btn-outline-primary action-btn">
                                                <i class="bi bi-info-circle me-1"></i> 详情
                                            </a>
                                            {% if battle.status in ['completed', 'error', 'playing','cancelled'] %}
                                                <a href="{{ url_for('visualizer.replay', game_id=battle.id) }}"
                                                   class="btn btn-sm btn-outline-info action-btn">
                                                    <i class="bi bi-play-fill me-1"></i> 回放
                                                </a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center no-results py-4">
                                        {% if current_filters.status or current_filters.date_from or current_filters.date_to or current_filters.players %}
                                            <i class="bi bi-search me-2"></i>没有找到符合筛选条件的对战记录
                                        {% else %}
                                            <i class="bi bi-controller me-2"></i>暂无对战记录
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% if battles_pagination and battles_pagination.pages > 1 %}
                <div class="card-footer">
                    <nav aria-label="Page navigation">
                        <ul class="pagination pagination-sm">
                            <li class="page-item {% if not battles_pagination.has_prev %}disabled{% endif %}">
                                <a class="page-link"
                                   {% if battles_pagination.has_prev %}href="{{ url_for('game.lobby', page=battles_pagination.prev_num, status=current_filters.status, date_from=current_filters.date_from, date_to=current_filters.date_to, players=current_filters.players) }}"{% else %}href="#" aria-disabled="true"{% endif %}>
                                    <i class="bi bi-chevron-left"></i> 上一页
                                </a>
                            </li>
                            {% for page_num in battles_pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                                {% if page_num %}
                                    {% if battles_pagination.page == page_num %}
                                        <li class="page-item active" aria-current="page">
                                            <span class="page-link">{{ page_num }}</span>
                                        </li>
                                    {% else %}
                                        <li class="page-item">
                                            <a class="page-link"
                                               href="{{ url_for('game.lobby', page=page_num, status=current_filters.status, date_from=current_filters.date_from, date_to=current_filters.date_to, players=current_filters.players) }}">{{ page_num }}</a>
                                        </li>
                                    {% endif %}
                                {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            <li class="page-item {% if not battles_pagination.has_next %}disabled{% endif %}">
                                <a class="page-link"
                                   {% if battles_pagination.has_next %}href="{{ url_for('game.lobby', page=battles_pagination.next_num, status=current_filters.status, date_from=current_filters.date_from, date_to=current_filters.date_to, players=current_filters.players) }}"{% else %}href="#" aria-disabled="true"{% endif %}>
                                    下一页 <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            {% endif %}
        </div>
    </div>
    <script>
const API_BASE_PATH = '/game';

// 玩家选择器功能
function initPlayerSelector() {
    const playerInput = document.getElementById('player_input');
    const addPlayerBtn = document.getElementById('addPlayerBtn');
    const playerTagsContainer = document.getElementById('playerTagsContainer');
    const MAX_PLAYERS = 7;
    
    function addPlayerTag(playerName) {
        if (!playerName) return false;
        
        playerName = playerName.trim();
        
        // 检查玩家是否已添加
        const existingTags = playerTagsContainer.querySelectorAll('.player-tag');
        for (let tag of existingTags) {
            if (tag.textContent.trim().replace('×', '') === playerName) {
                // 提示已存在
                playerInput.classList.add('is-invalid');
                setTimeout(() => playerInput.classList.remove('is-invalid'), 1000);
                return false;
            }
        }
        
        // 检查是否达到最大限制
        if (existingTags.length >= MAX_PLAYERS) {
            playerTagsContainer.classList.add('limit-reached');
            setTimeout(() => playerTagsContainer.classList.remove('limit-reached'), 1000);
            return false;
        }
        
        // 创建并添加标签
        const tag = document.createElement('div');
        tag.className = 'player-tag';
        tag.innerHTML = `
            ${playerName}
            <span class="remove-tag" data-player="${playerName}" title="移除">×</span>
            <input type="hidden" name="players" value="${playerName}">
        `;
        
        // 绑定删除事件
        tag.querySelector('.remove-tag').addEventListener('click', () => {
            tag.remove();
            playerTagsContainer.classList.remove('limit-reached');
        });
        
        // 添加到容器
        playerTagsContainer.appendChild(tag);
        
        // 清空输入框并聚焦
        playerInput.value = '';
        playerInput.focus();
        
        return true;
    }
    
    // 绑定按钮点击事件
    addPlayerBtn.addEventListener('click', () => addPlayerTag(playerInput.value));
    
    // 绑定Enter键事件
    playerInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            addPlayerTag(playerInput.value);
        }
    });
    
    // 绑定已有标签的删除事件
    document.querySelectorAll('.player-tag .remove-tag').forEach(btn => {
        btn.addEventListener('click', () => btn.closest('.player-tag').remove());
    });
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    // 初始化玩家选择器
    initPlayerSelector();
    
    // 加载对战统计数据
    loadBattlesStats();
    
    // 加载对战列表，默认第一页
    loadBattlesList(1);
    
    // 设置筛选表单提交事件
    document.getElementById('battleFilterForm').addEventListener('submit', function(e) {
        e.preventDefault();
        loadBattlesList(1); // 重新加载第一页
    });
    
    // 防抖函数
    function debounce(func, wait) {
        let timeout;
        return function() {
            const context = this, args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }
    
    // 启用表格行的延迟加载
    const battlesTable = document.getElementById('battlesTable');
    if (battlesTable) {
        // 初始只显示前10行
        const allRows = battlesTable.querySelectorAll('tbody tr:not(#lazyLoadRow)');
        for (let i = 10; i < allRows.length; i++) {
            allRows[i].style.display = 'none';
        }
        
        // 滚动时显示更多行
        let visibleRows = 10;
        const showMoreRows = debounce(function() {
            for (let i = visibleRows; i < Math.min(visibleRows + 5, allRows.length); i++) {
                if (allRows[i]) allRows[i].style.display = '';
            }
            visibleRows += 5;
            
            // 如果所有行都显示，移除滚动监听
            if (visibleRows >= allRows.length) {
                window.removeEventListener('scroll', handleScroll);
                const lazyLoadRow = document.getElementById('lazyLoadRow');
                if (lazyLoadRow) lazyLoadRow.style.display = 'none';
            }
        }, 200);
        
        // 滚动处理函数
        function handleScroll() {
            const scrollPos = window.scrollY + window.innerHeight;
            const tableBottom = battlesTable.offsetTop + battlesTable.offsetHeight;
            
            if (scrollPos > tableBottom - 300) {
                showMoreRows();
            }
        }
        
        // 添加滚动监听
        window.addEventListener('scroll', handleScroll);
        
        // 用户列表懒加载
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        if (loadMoreBtn && {{ all_users|length }} < 20) {
            loadMoreBtn.classList.remove('d-none');
            loadMoreBtn.addEventListener('click', function() {
                window.location.href = "{{ url_for('game.lobby', load_users='true') }}" + 
                                       window.location.search.replace(/[?&]load_users=true/, '');
            });
        }
    }
    
    // 优化玩家下拉列表加载
    const playerInput = document.getElementById('player_input');
    if (playerInput) {
        playerInput.setAttribute('autocomplete', 'off');
    }
});

// 加载对战统计数据
function loadBattlesStats() {
    // 显示加载指示器
    const statsContainer = document.querySelector('.card-body .row');
    if (statsContainer) {
        statsContainer.innerHTML = `
            <div class="col-12 text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2 text-muted">正在加载统计数据...</p>
            </div>
        `;
    }
    
    // 发起AJAX请求
    fetch(`${API_BASE_PATH}/api/battles/stats`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 更新对战状态统计
                updateBattlesStats(data.battles_count, data.automatch_is_on, data.automatch_status);
            } else {
                // 显示错误消息
                if (statsContainer) {
                    statsContainer.innerHTML = `
                        <div class="col-12 text-center py-4">
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                加载统计数据失败: ${data.message || '未知错误'}
                            </div>
                        </div>
                    `;
                }
            }
        })
        .catch(error => {
            console.error('加载统计数据出错:', error);
            if (statsContainer) {
                statsContainer.innerHTML = `
                    <div class="col-12 text-center py-4">
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            加载统计数据出错，请刷新页面重试
                        </div>
                    </div>
                `;
            }
        });
}

// 更新对战统计UI
function updateBattlesStats(battles_count, automatch_is_on, automatch_status) {
    // 构建统计区域HTML，使用stats-grid类来实现网格布局
    let statsHTML = `
        <div class="col-lg-8">
            <h6 class="border-bottom pb-1 mb-2">对战状态分布</h6>
            <div class="row stats-container stats-grid g-2">
                <div>
                    <div class="p-3 bg-light rounded shadow-sm">
                        <h3 class="text-primary mb-1">${battles_count.total}</h3>
                        <p class="text-muted mb-0 small">总对战数</p>
                    </div>
                </div>
                <div>
                    <div class="p-3 bg-light rounded shadow-sm">
                        <h3 class="text-info mb-1">${battles_count.playing}</h3>
                        <p class="text-muted mb-0 small">进行中</p>
                    </div>
                </div>
                <div>
                    <div class="p-3 bg-light rounded shadow-sm">
                        <h3 class="text-warning mb-1">${battles_count.waiting}</h3>
                        <p class="text-muted mb-0 small">等待中</p>
                    </div>
                </div>
                <div>
                    <div class="p-3 bg-light rounded shadow-sm">
                        <h3 class="text-success mb-1">${battles_count.completed}</h3>
                        <p class="text-muted mb-0 small">已完成</p>
                    </div>
                </div>
                <div>
                    <div class="p-3 bg-light rounded shadow-sm">
                        <h3 class="text-danger mb-1">${battles_count.error}</h3>
                        <p class="text-muted mb-0 small">错误</p>
                    </div>
                </div>
                <div>
                    <div class="p-3 bg-light rounded shadow-sm">
                        <h3 class="text-secondary mb-1">${battles_count.cancelled}</h3>
                        <p class="text-muted mb-0 small">已取消</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <h6 class="border-bottom pb-1 mb-2">自动对战状态</h6>
            <div class="p-3 bg-light rounded shadow-sm">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span>状态:</span>
                    <span class="badge ${automatch_is_on ? 'bg-success' : 'bg-secondary'}">
                        ${automatch_is_on ? '运行中' : '未运行'}
                    </span>
                </div>
    `;
    
    // 添加活跃榜单信息
    if (automatch_is_on && automatch_status.active_rankings && automatch_status.active_rankings.length > 0) {
        statsHTML += `
            <div class="mt-2">
                <h6 class="small fw-bold">活跃榜单</h6>
                <ul class="list-group list-group-flush small p-0">
        `;
        
        automatch_status.active_rankings.forEach(ranking => {
            let rankingName = '';
            if (ranking.ranking_id === 0) {
                rankingName = `测试赛 #${ranking.ranking_id}`;
            } else if (1 <= ranking.ranking_id && ranking.ranking_id <= 10) {
                rankingName = `初赛 #${ranking.ranking_id}`;
            } else if (11 <= ranking.ranking_id && ranking.ranking_id <= 20) {
                rankingName = `半决赛 #${ranking.ranking_id}`;
            } else if (21 <= ranking.ranking_id && ranking.ranking_id <= 30) {
                rankingName = `决赛 #${ranking.ranking_id}`;
            } else {
                rankingName = `未知赛事 #${ranking.ranking_id}`;
            }
            
            statsHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center py-1">
                    <small>${rankingName}</small>
                    <small class="text-muted">${ranking.battle_count}对战/${ranking.participants}参与者</small>
                </li>
            `;
        });
        
        statsHTML += `
                </ul>
            </div>
        `;
    }
    
    statsHTML += `
            </div>
        </div>
    `;
    
    // 更新UI
    const statsContainer = document.querySelector('.card-body .row');
    if (statsContainer) {
        statsContainer.innerHTML = statsHTML;
    }
    
    // 设置定时刷新，每60秒更新一次
    setTimeout(loadBattlesStats, 60000);
}

// 获取对战列表
function loadBattlesList(page) {
    // 获取筛选条件
    const status = document.getElementById('status').value;
    const dateFrom = document.getElementById('date_from').value;
    const dateTo = document.getElementById('date_to').value;
    const playerTags = Array.from(document.querySelectorAll('.player-tag input[name="players"]')).map(input => input.value);
    
    // 构建查询参数
    const params = new URLSearchParams();
    params.append('page', page);
    params.append('per_page', 5);
    if (status && status !== 'all') params.append('status', status);
    if (dateFrom) params.append('date_from', dateFrom);
    if (dateTo) params.append('date_to', dateTo);
    playerTags.forEach(tag => params.append('players', tag));
    
    // 显示加载指示器
    const tableBody = document.querySelector('#battlesTable tbody');
    if (tableBody) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-2 text-muted">正在加载对战列表...</p>
                </td>
            </tr>
        `;
    }
    
    // 明确查找对战列表所在的卡片
    const battleListCard = document.querySelector('#battlesTable').closest('.card');
    
    // 确保分页容器存在
    let paginationContainer = battleListCard.querySelector('.card-footer');
    if (!paginationContainer) {
        // 如果不存在，创建一个
        paginationContainer = document.createElement('div');
        paginationContainer.className = 'card-footer';
        battleListCard.appendChild(paginationContainer);
    }
    
    // 清空分页内容
    paginationContainer.innerHTML = '';
    
    // 发起AJAX请求
    fetch(`${API_BASE_PATH}/api/battles/list?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 更新对战列表
                updateBattlesList(data.battles, data.pagination);
            } else {
                // 显示错误消息
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <div class="alert alert-danger">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    加载对战列表失败: ${data.message || '未知错误'}
                                </div>
                            </td>
                        </tr>
                    `;
                }
            }
        })
        .catch(error => {
            console.error('加载对战列表出错:', error);
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                加载对战列表出错，请刷新页面重试
                            </div>
                        </td>
                    </tr>
                `;
            }
        });
}

// 更新对战列表UI
function updateBattlesList(battles, pagination) {
    const tableBody = document.querySelector('#battlesTable tbody');
    
    if (!tableBody) return;
    
    // 如果没有数据
    if (!battles || battles.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center no-results py-4">
                    <i class="bi bi-search me-2"></i>没有找到符合筛选条件的对战记录
                </td>
            </tr>
        `;
        return;
    }
    
    // 构建对战列表HTML
    let battlesHTML = '';
    
    // 更新对战列表UI中的回放按钮部分
    battles.forEach(battle => {
        battlesHTML += `
            <tr class="battle-card">
                <td>
                    <a href="${API_BASE_PATH}/battle/${battle.id}" class="battle-id text-decoration-none">${battle.id.substring(0, 8)}...</a>
                </td>
                <td>
                    ${getStatusBadge(battle.status)}
                </td>
                <td>
                    ${getBattleTypeBadge(battle.battle_type, battle.is_elo_exempt, battle.ranking_id)}
                </td>
                <td>${battle.created_at}</td>
                <td>${battle.ended_at}</td>
                <td>
                    <a href="${API_BASE_PATH}/battle/${battle.id}" class="btn btn-sm btn-outline-primary action-btn">
                        <i class="bi bi-info-circle me-1"></i> 详情
                    </a>
                    ${battle.status === 'completed' || battle.status === 'error' || battle.status === 'playing' || battle.status === 'cancelled' ? 
                    `<a href="/visualizer/replay/${battle.id}" class="btn btn-sm btn-outline-info action-btn">
                        <i class="bi bi-play-fill me-1"></i> 回放
                    </a>` : ''}
                </td>
            </tr>
        `;
    });
    
    // 更新表格
    tableBody.innerHTML = battlesHTML;
    
    // 更新分页
    updatePagination(pagination);
}

// 获取状态标签HTML
function getStatusBadge(status) {
    switch (status) {
        case 'completed':
            return '<span class="badge status-completed">已完成</span>';
        case 'playing':
            return '<span class="badge status-playing">进行中</span>';
        case 'waiting':
            return '<span class="badge status-waiting">等待中</span>';
        case 'error':
            return '<span class="badge status-error">错误</span>';
        case 'cancelled':
            return '<span class="badge status-cancelled">已取消</span>';
        default:
            return `<span class="badge bg-light text-dark">${status}</span>`;
    }
}

// 获取对战类型标签HTML
function getBattleTypeBadge(battle_type, is_elo_exempt, ranking_id) {
    if (battle_type === 'ai_series_test') {
        return '<span class="badge bg-secondary" data-bs-toggle="tooltip" title="AI系列位置测试赛 (不计ELO)">系列测试</span>';
    } else if (is_elo_exempt) {
        return '<span class="badge bg-light text-dark" data-bs-toggle="tooltip" title="此对战不计入ELO/统计">豁免赛</span>';
    } else {
        if (ranking_id === 0) {
            return '<span class="badge bg-info">测试赛</span>';
        } else if (1 <= ranking_id && ranking_id <= 10) {
            return '<span class="badge bg-info">初赛</span>';
        } else if (11 <= ranking_id && ranking_id <= 20) {
            return '<span class="badge bg-info">半决赛</span>';
        } else if (21 <= ranking_id && ranking_id <= 30) {
            return '<span class="badge bg-info">决赛</span>';
        } else {
            return '<span class="badge bg-info">标准赛</span>';
        }
    }
}

// 更新分页UI
function updatePagination(pagination) {
    if (!pagination || pagination.pages <= 1) return;
    
    const paginationContainer = document.querySelector('.card-footer');
    if (!paginationContainer) return;
    
    let paginationHTML = `
        <nav aria-label="Page navigation">
            <ul class="pagination pagination-sm">
                <li class="page-item ${!pagination.has_prev ? 'disabled' : ''}">
                    <a class="page-link" href="#" ${pagination.has_prev ? `onclick="loadBattlesList(${pagination.prev_num}); return false;"` : 'aria-disabled="true"'}>
                        <i class="bi bi-chevron-left"></i> 上一页
                    </a>
                </li>
    `;
    
    // 生成页码按钮
    const totalPages = pagination.pages;
    const currentPage = pagination.page;
    
    // 显示逻辑：总是显示第一页、最后一页，当前页及其前后页
    const pagesToShow = [];
    pagesToShow.push(1);
    
    for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) {
        pagesToShow.push(i);
    }
    
    if (totalPages > 1) {
        pagesToShow.push(totalPages);
    }
    
    // 去重并排序
    const uniquePages = [...new Set(pagesToShow)].sort((a, b) => a - b);
    
    let prevPage = 0;
    for (const page of uniquePages) {
        // 如果有间隔，添加省略号
        if (page - prevPage > 1) {
            paginationHTML += `
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
            `;
        }
        
        // 添加页码按钮
        paginationHTML += `
            <li class="page-item ${page === currentPage ? 'active' : ''}" ${page === currentPage ? 'aria-current="page"' : ''}>
                ${page === currentPage ? 
                    `<span class="page-link">${page}</span>` : 
                    `<a class="page-link" href="#" onclick="loadBattlesList(${page}); return false;">${page}</a>`
                }
            </li>
        `;
        
        prevPage = page;
    }
    
    // 添加"下一页"按钮
    paginationHTML += `
        <li class="page-item ${!pagination.has_next ? 'disabled' : ''}">
            <a class="page-link" href="#" ${pagination.has_next ? `onclick="loadBattlesList(${pagination.next_num}); return false;"` : 'aria-disabled="true"'}>
                下一页 <i class="bi bi-chevron-right"></i>
            </a>
        </li>
    `;
    
    // 关闭标签
    paginationHTML += `
            </ul>
        </nav>
    `;
    
    // 更新分页容器内容
    paginationContainer.innerHTML = paginationHTML;
    
    // 确保分页容器可见
    paginationContainer.style.display = 'block';
}

// 绑定刷新按钮事件
document.getElementById('refreshStatsBtn').addEventListener('click', function() {
    loadBattlesStats();
});

document.getElementById('refreshListBtn').addEventListener('click', function() {
    const currentPage = document.querySelector('.pagination .active') ? 
        parseInt(document.querySelector('.pagination .active').textContent) : 1;
    loadBattlesList(currentPage);
});
    </script>
{% endblock content %}
