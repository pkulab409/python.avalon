{% extends "base.html" %}
{% block title %}
    ÂØπÂ±ÄÈáçÊîæ - {{ game_id }}
{% endblock title %}
{% block styles %}
    <link rel="stylesheet" href="../../static/css/medieval.css">
    {{ super() }}
    <style>
    /* Âü∫Á°ÄÂìçÂ∫îÂºèËÆæÁΩÆ */
    :root {
        --sidebar-width: 300px;
        --chat-width: 600px;
        --map-width: 300px;
    }

    @media (max-width: 768px) {
        :root {
            --sidebar-width: 100%;
            --chat-width: 100%;
            --map-width: 100%;
        }
    }

    .navbar {
        background: none !important;
        background-image: url('../../static/images/wood-texture.png') !important;
        background-size: cover !important;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
        position: relative;
    }

    /* ÁßªÂä®Á´ØÂØºËà™Ê†èÊ†∑Âºè */
    @media (max-width: 768px) {
        .navbar {
            padding: 0.5rem;
        }

        .navbar-brand {
            font-size: 1.2rem;
        }
    }

    /* ÂºÄÂú∫Âä®ÁîªÊ†∑Âºè */
    .intro-animation {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #222222;
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 1;
        transition: opacity 0.5s ease-out;
    }

    .intro-animation.fade-out {
        opacity: 0;
    }

    .intro-content {
        text-align: center;
        color: #fff;
        padding: 1rem;
    }

    .intro-title {
        font-size: clamp(2rem, 5vw, 3rem);
        color: #ffffff;
        margin-bottom: 1rem;
        opacity: 0;
        transform: translateY(20px);
        animation: fadeInUp 1s ease forwards;
    }

    .intro-subtitle {
        font-size: clamp(1rem, 3vw, 1.5rem);
        opacity: 0;
        transform: translateY(20px);
        animation: fadeInUp 1s ease 0.5s forwards;
    }

    .loading-bar {
        width: 200px;
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        margin: 2rem auto;
        border-radius: 2px;
        overflow: hidden;
        opacity: 0;
        animation: fadeIn 0.5s ease 0.5s forwards;
    }

    .loading-progress {
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, #4a90e2, #67b26f);
        animation: loading 2s ease 1s forwards;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    @keyframes loading {
        from {
            width: 0%;
        }
        to {
            width: 100%;
        }
    }

    /* ËÅäÂ§©ÂÆπÂô®Ê†∑Âºè */
    .chat-container {
        height: calc(100vh - 250px);
        overflow-y: auto;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        background-image: url('../../static/images/parchment-bg.png');
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center;
    }

    @media (max-width: 768px) {
        .chat-container {
            height: calc(100vh - 200px);
            padding: 0.5rem;
        }
    }

    /* ÂõûÂêàÂàÜÈöîÁ∫ø */
    .round-divider {
        clear: both;
        text-align: center;
        margin: 25px 0 15px 0;
        position: relative;
    }

    .round-divider:before {
        content: "";
        position: absolute;
        left: 0;
        top: 50%;
        width: 100%;
        height: 1px;
        background-color: #dee2e6;
        z-index: 0;
    }

    .round-divider span {
        display: inline-block;
        padding: 5px 15px;
        background-color: #fff;
        position: relative;
        z-index: 1;
        font-weight: bold;
        border-radius: 15px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #dee2e6;
    }

    /* Ê∂àÊÅØÊ∞îÊ≥°Âü∫Á°ÄÊ†∑Âºè */
    .message-bubble {
        max-width: 100%;
        padding: 8px 12px;
        border-radius: 15px;
        position: relative;
        word-break: break-word;
        margin-bottom: 5px;
        display: inline-block;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 768px) {
        .message-bubble {
            padding: 6px 10px;
            font-size: 0.9rem;
        }
    }

    /* Áé©ÂÆ∂Â§¥ÂÉèÊ†∑Âºè */
    .player-avatar {
        width: 72px;
        height: 96px;
        border-radius: 50%;
        margin-right: 8px;
        margin-left: 8px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        font-size: 0.9rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        border: 2px solid #fff;
        background-size: 300%;
        background-position: center 20%;
        background-repeat: no-repeat;
        overflow: hidden;
    }

    .player-avatar.role-merlin {
        background-image: url('../../static/images/merlin.jpg');
    }

    .player-avatar.role-percival {
        background-image: url('../../static/images/percival.jpg');
    }

    .player-avatar.role-knight1 {
        background-image: url('../../static/images/knight1.jpg');
    }

    .player-avatar.role-knight2 {
        background-image: url('../../static/images/knight2.jpg');
    }

    .player-avatar.role-assassin {
        background-image: url('../../static/images/assassin.jpg');
    }

    .player-avatar.role-morgana {
        background-image: url('../../static/images/morgana.jpg');
    }

    .player-avatar.role-oberon {
        background-image: url('../../static/images/oberon.jpg');
    }

    /* Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÂØπÂ∫îËßíËâ≤ÂõæÁâáÔºå‰ΩøÁî®ÈªòËÆ§ÁöÑÂΩ©Ëâ≤ËÉåÊôØ */
    .player-avatar.blue {
        background-color: #4A6B8A;
    }

    .player-avatar.red {
        background-color: #8B0000;
    }

    .player-avatar.unknown {
        background-color: #6c757d;
    }

    @media (max-width: 768px) {
        .player-avatar {
            width: 40px;
            height: 28px;
            margin-right: 6px;
            margin-left: 6px;
            font-size: 0.8rem;
            border-radius: 50%;
            background-size: 200%;
            background-position: center 30%;
        }
    }

    /* TTSÊí≠ÊîæÊåâÈíÆÊ†∑Âºè */
    .tts-play-btn {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: none;
        background: #007bff;
        color: white;
        font-size: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: all 0.2s ease;
        z-index: 10;
    }

    .tts-play-btn:hover {
        background: #0056b3;
        transform: scale(1.1);
    }

    .tts-play-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
    }

    .tts-play-btn.loading {
        background: #ffc107;
        animation: pulse 1.5s infinite;
    }

    .tts-play-btn.playing {
        background: #28a745;
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        0% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
        100% {
            opacity: 1;
        }
    }

    /* ËìùÊñπÊ∂àÊÅØ */
    .message-blue {
        background-color: rgb(190, 208, 235);
        border: 1px solid #9ec5fe;
        color: #052c65;
    }

    /* Á∫¢ÊñπÊ∂àÊÅØ */
    .message-red {
        background-color: rgb(236, 207, 210);
        border: 1px solid #f5c2c7;
        color: #58151c;
    }

    /* Á≥ªÁªü/‰∏≠Á´ãÊ∂àÊÅØ */
    .message-system {
        background-color: #e9ecef;
        border: 1px solid #ced4da;
        color: #495057;
        text-align: center;
        padding: 6px 10px;
        font-size: 0.9em;
        margin: 10px auto;
        display: block;
        clear: both;
    }

    /* Áé©ÂÆ∂Ê†áÁ≠æÊ†∑Âºè */
    .player-tag {
        font-size: 0.8rem;
        margin-bottom: 2px;
        font-weight: bold;
        padding: 0 5px;
        display: flex;
        align-items: center;
    }

    /* Ê∂àÊÅØÂåÖË£ÖÂô®Ê†∑Âºè */
    .message-wrapper {
        max-width: 80%;
        margin-bottom: 15px;
        position: relative;
        clear: both;
        display: flex;
        align-items: flex-end;
    }

    .message-wrapper-blue {
        float: left;
        margin-left: 5px;
        flex-direction: row;
    }

    .message-wrapper-red {
        float: right;
        margin-right: 5px;
        flex-direction: row-reverse;
    }

    .message-wrapper-blue .player-tag {
        text-align: left;
    }

    .message-wrapper-red .player-tag {
        text-align: right;
    }

    .message-content {
        flex: 1;
        min-width: 0;
    }

    /* Ê∏ÖÈô§ÊµÆÂä® */
    .clearfix::after {
        content: "";
        clear: both;
        display: table;
    }

    /* ÊäïÁ•®‰ø°ÊÅØÊ†∑Âºè */
    .vote-info {
        clear: both;
        text-align: center;
        margin: 15px 0;
        padding: 10px;
        background-color: #f8f9fa;
        border: 1px dashed #ced4da;
        border-radius: 5px;
    }

    .vote-badge {
        margin: 2px;
    }

    /* ‰ªªÂä°ÁªìÊûúÊ†∑Âºè */
    .mission-result-info {
        clear: both;
        text-align: center;
        margin: 15px 0;
    }

    /* ‰æßËæπÊ†èÊ†∑Âºè */
    .sidebar {
        overflow-y: auto;
        max-height: calc(100vh - 100px);
    }

    /* Âú∞ÂõæÊ†∑Âºè */
    .game-map {
        display: grid;
        grid-template-columns: repeat({{ map_size }}, 1fr);
        grid-template-rows: repeat({{ map_size }}, 1fr);
        gap: 0px;
        padding: 5px;
        border-radius: 4px;
        max-width: 100%;
        margin: 0 auto;
        border: 3px solid #9e8a5d;
        background-image: url('../../static/images/map-background.png');
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center;
    }

    @media (max-width: 768px) {
        .game-map {
            max-width: 100%;
            margin: 0.5rem auto;
        }

        .map-cell {
            font-size: 0.6rem;
        }

        .player-token {
            width: 90%;
            height: 90%;
            font-size: 0.7rem;
        }
    }

    .map-cell {
        aspect-ratio: 1;
        border: 1.3px solid #9e8a5d;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        font-weight: bold;
        font-size: 0.7rem;
        background-color: rgba(255, 255, 255, 0.3);
    }

    .player-token {
        width: 85%;
        height: 85%;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 0.8rem;
        box-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
        cursor: help;
    }

    .player-blue {
        background-color: #4A6B8A;
    }

    .player-red {
        background-color: #8B0000;
    }

    .player-unknown {
        background-color: #6c757d;
    }

    /* ÂÖ∂‰ªñÊ†∑Âºè‰øùÊåÅ‰∏çÂèò */
    .bg-success-light {
        background-color: #d1e7dd;
    }

    .bg-danger-light {
        background-color: #f8d7da;
    }

    .tooltip-icon {
        margin-left: 5px;
        cursor: help;
    }

    .role-icon {
        width: 24px;
        height: 24px;
        margin-right: 5px;
    }

    /* ÁßÅÊúâÂèëË®ÄÊ†∑Âºè */
    .message-bubble.private-speech {
        border-style: dashed;
        background-color: rgba(200, 200, 200, 0.3);
    }

    .speech-badge,
    .hearers-tags {
        display: inline-block;
        margin-right: 2px;
        font-size: 0.65rem;
        margin-left: 5px;
        vertical-align: middle;
    }

    h4,
    h5 {
        color: #ffffff;
        font-weight: bold;
    }

    /* Ëá™Âä®Ë∑≥Âä®ÂõûÊîæÈ´ò‰∫ÆÊ†∑Âºè */
    .auto-replay-active {
        background: #ffe082 !important;
        transition: background 0.3s;
        transform: scale(1.02);
        box-shadow: 0 2px 8px rgba(255, 224, 130, 0.5) !important;
    }

    /* ÁßªÂä®Ê∂àÊÅØ‰∫§‰∫íÊ†∑Âºè */
    .move-message {
        transition: all 0.3s ease;
    }

    .move-message:hover {
        background-color: #f8f9fa !important;
        transform: scale(1.02);
        cursor: pointer;
        border: 1px solid #007bff;
    }

    .highlighted-move {
        background-color: #fff3cd !important;
        border: 2px solid #ffc107 !important;
        transform: scale(1.02);
        box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
    }

    /* Âà∫ÊùÄÊàêÂäüÂä®ÁîªÊ†∑Âºè */
    .assassination-success-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle, rgba(139, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.95) 100%);
        z-index: 10000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        opacity: 0;
        animation: assassinationFadeIn 1s ease forwards;
    }

    .assassination-title {
        font-size: clamp(3rem, 8vw, 6rem);
        color: #ff0000;
        text-shadow: 0 0 20px #ff0000, 0 0 40px #ff0000, 0 0 60px #ff0000;
        margin-bottom: 2rem;
        opacity: 0;
        transform: scale(0.3) translateY(50px);
        animation: assassinationTitleAppear 2s ease 0.5s forwards;
    }

    .assassination-subtitle {
        font-size: clamp(1.5rem, 4vw, 2.5rem);
        color: #ffffff;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        margin-bottom: 1rem;
        opacity: 0;
        transform: translateY(50px);
        animation: assassinationSubtitleAppear 1.5s ease 1.5s forwards;
    }

    .assassination-details {
        font-size: clamp(1rem, 2vw, 1.2rem);
        color: #cccccc;
        text-align: center;
        max-width: 600px;
        line-height: 1.6;
        opacity: 0;
        transform: translateY(30px);
        animation: assassinationDetailsAppear 1s ease 2.5s forwards;
    }

    .blood-effect {
        position: absolute;
        width: 100%;
        height: 100%;
        background: 
            radial-gradient(circle at 20% 30%, rgba(139, 0, 0, 0.3) 0%, transparent 50%),
            radial-gradient(circle at 80% 70%, rgba(139, 0, 0, 0.2) 0%, transparent 40%),
            radial-gradient(circle at 60% 20%, rgba(139, 0, 0, 0.4) 0%, transparent 30%);
        animation: bloodPulse 3s ease-in-out infinite;
    }

    .dagger-icon {
        position: absolute;
        top: 20%;
        right: 15%;
        font-size: 4rem;
        color: #c0c0c0;
        transform: rotate(45deg) scale(0);
        animation: daggerStrike 2s ease 1s forwards;
    }

    .victory-crown {
        position: absolute;
        top: 15%;
        left: 15%;
        font-size: 3rem;
        color: #ffd700;
        transform: scale(0) rotate(-180deg);
        animation: crownAppear 1.5s ease 2s forwards;
    }

    .close-animation-btn {
        position: absolute;
        bottom: 5%;
        right: 5%;
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid #ffffff;
        color: #ffffff;
        padding: 0.8rem 1.5rem;
        border-radius: 25px;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.3s ease;
        opacity: 0;
        animation: closeButtonAppear 0.5s ease 3.5s forwards;
    }

    .close-animation-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
    }

    /* ËÉúÂà©Ê®™ÂπÖÂä®ÁîªÊ†∑Âºè */
    .victory-banner {
        position: fixed;
        top: 50%;
        left: -100%;
        width: 100%;
        height: auto;
        min-height: 100px;
        max-height: 80vh;
        padding: 20px 40px;
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        transform: translateY(-50%) rotate(-3deg);
        animation: victorySlideIn 1.5s ease-out forwards;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        overflow: hidden;
        border: 4px solid #ffd700;
        border-radius: 15px;
    }

    .victory-banner.blue {
        background: linear-gradient(45deg, #4A6B8A, #6A9BD2, #4A6B8A);
        background-size: 200% 200%;
        animation: victorySlideIn 1.5s ease-out forwards, blueShimmer 3s ease-in-out infinite;
        border-color: #4A6B8A;
        box-shadow: 0 0 20px rgba(74, 107, 138, 0.7), inset 0 0 20px rgba(135, 206, 235, 0.4);
    }

    .victory-banner.red {
        background: linear-gradient(45deg, #8B0000, #DC143C, #8B0000);
        background-size: 200% 200%;
        animation: victorySlideIn 1.5s ease-out forwards, redShimmer 3s ease-in-out infinite;
        border-color: #8B0000;
        box-shadow: 0 0 20px rgba(139, 0, 0, 0.7), inset 0 0 20px rgba(220, 20, 60, 0.4);
    }

    .victory-content {
        text-align: center;
        z-index: 2;
        position: relative;
        width: 100%;
        max-width: 80%;
        margin: 0 auto;
        padding: 0 1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #ffffff;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    }

    .victory-title {
        font-size: clamp(1.5rem, 4vw, 2.5rem);
        font-weight: bold;
        margin: 0 0 0.5rem 0;
        text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.7);
        color: #ffffff;
        opacity: 0;
        transform: scale(0.5);
        animation: victoryTitleAppear 1s ease 0.5s forwards;
        white-space: nowrap;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .victory-subtitle {
        font-size: clamp(0.9rem, 2vw, 1.2rem);
        margin: 0.3rem 0;
        color: rgba(255, 255, 255, 0.9);
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.6);
        opacity: 0;
        transform: translateY(20px);
        animation: victorySubtitleAppear 0.8s ease 1s forwards;
        white-space: nowrap;
    }

    .victory-reason {
        font-size: clamp(0.7rem, 1.5vw, 0.9rem);
        margin: 0.2rem 0 0 0;
        color: rgba(255, 255, 255, 0.8);
        font-style: italic;
        opacity: 0;
        transform: translateY(15px);
        animation: victoryReasonAppear 0.6s ease 1.5s forwards;
        max-width: 90%;
        text-align: center;
        line-height: 1.3;
        word-wrap: break-word;
    }

    .victory-particles {
        position: absolute;
        width: 100%;
        height: 100%;
        overflow: hidden;
        pointer-events: none;
        top: 0;
        left: 0;
    }

    .victory-particle {
        position: absolute;
        width: 6px;
        height: 6px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        animation: particleFall 3s linear infinite;
    }

    .victory-banner.blue .victory-particle {
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 0 4px rgba(106, 155, 210, 0.8);
    }

    .victory-banner.red .victory-particle {
        background: rgba(255, 215, 0, 0.9);
        box-shadow: 0 0 4px rgba(220, 20, 60, 0.8);
    }

    .victory-icon {
        position: absolute;
        font-size: clamp(1.5rem, 3vw, 2rem);
        opacity: 0;
        animation: victoryIconSpin 1.5s ease 2s forwards;
        color: rgba(255, 255, 255, 0.9);
    }

    .victory-icon.left {
        left: 10%;
        top: 50%;
        transform: translateY(-50%) rotate(-180deg) scale(0);
    }

    .victory-icon.right {
        right: 10%;
        top: 50%;
        transform: translateY(-50%) rotate(180deg) scale(0);
    }

    .victory-close-btn {
        position: absolute;
        top: 10px;
        right: 15px;
        background: rgba(0, 0, 0, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.7);
        color: rgba(255, 255, 255, 0.9);
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.1rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        opacity: 0;
        animation: victoryCloseAppear 0.5s ease 2.5s forwards;
        z-index: 10;
    }

    .victory-close-btn:hover {
        background: rgba(0, 0, 0, 0.6);
        border-color: #ffffff;
        color: #ffffff;
        transform: scale(1.1);
    }

    /* ÁßªÂä®Á´Ø‰ºòÂåñ */
    @media (max-width: 768px) {
        .victory-banner {
            height: auto;
            min-height: 80px;
            max-height: 70vh;
            padding: 15px 20px;
            transform: translateY(-50%) rotate(-2deg);
            border-radius: 10px;
        }

        .victory-content {
            padding: 0 0.5rem;
            max-width: 90%;
        }

        .victory-title {
            font-size: clamp(1.2rem, 5vw, 1.8rem);
            margin-bottom: 0.3rem;
            letter-spacing: 0.5px;
        }

        .victory-subtitle {
            font-size: clamp(0.8rem, 2.5vw, 1rem);
            margin: 0.2rem 0;
        }

        .victory-reason {
            font-size: clamp(0.65rem, 2vw, 0.8rem);
            margin: 0.2rem 0 0 0;
            max-width: 95%;
            line-height: 1.2;
        }

        .victory-icon {
            font-size: clamp(1.2rem, 4vw, 1.6rem);
        }

        .victory-icon.left {
            left: 8%;
        }

        .victory-icon.right {
            right: 8%;
        }

        .victory-close-btn {
            top: 8px;
            right: 12px;
            width: 28px;
            height: 28px;
            font-size: 1rem;
        }
    }

    /* Ë∂ÖÂ∞èÂ±èÂπï‰ºòÂåñ */
    @media (max-width: 480px) {
        .victory-banner {
            min-height: 70px;
            padding: 10px 15px;
            transform: translateY(-50%) rotate(-1deg);
            border-radius: 8px;
        }

        .victory-content {
            padding: 0 0.3rem;
            max-width: 95%;
        }

        .victory-title {
            font-size: clamp(1rem, 6vw, 1.5rem);
            line-height: 1.1;
            letter-spacing: 0px;
        }

        .victory-subtitle {
            font-size: clamp(0.7rem, 3vw, 0.9rem);
        }

        .victory-reason {
            font-size: clamp(0.6rem, 2.5vw, 0.7rem);
            line-height: 1.2;
            max-width: 98%;
        }

        .victory-icon {
            font-size: clamp(1rem, 4.5vw, 1.3rem);
        }

        .victory-icon.left {
            left: 5%;
        }

        .victory-icon.right {
            right: 5%;
        }

        .victory-close-btn {
            top: 5px;
            right: 8px;
            width: 24px;
            height: 24px;
            font-size: 0.9rem;
        }
    }

    /* Ê∑ªÂä†Âä®ÁîªÂÖ≥ÈîÆÂ∏ß - Á°Æ‰øùÊªëÂÖ•Âä®ÁîªÊ≠£Á°Æ */
    @keyframes victorySlideIn {
        0% {
            left: -100%;
            opacity: 0;
        }
        100% {
            left: 0;
            opacity: 1;
        }
    }

    @keyframes victorySlideOut {
        0% {
            left: 0;
            opacity: 1;
        }
        100% {
            left: 100%;
            opacity: 0;
        }
    }

    @keyframes victoryTitleAppear {
        0% {
            opacity: 0;
            transform: scale(0.5) translateY(20px);
        }
        100% {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    @keyframes victorySubtitleAppear {
        0% {
            opacity: 0;
            transform: translateY(20px);
        }
        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes victoryReasonAppear {
        0% {
            opacity: 0;
            transform: translateY(15px);
        }
        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes victoryIconSpin {
        0% {
            opacity: 0;
            transform: translateY(-50%) rotate(-180deg) scale(0);
        }
        100% {
            opacity: 1;
            transform: translateY(-50%) rotate(0deg) scale(1);
        }
    }

    @keyframes victoryCloseAppear {
        0% {
            opacity: 0;
            transform: scale(0.5);
        }
        100% {
            opacity: 1;
            transform: scale(1);
        }
    }

    @keyframes particleFall {
        0% {
            opacity: 0;
            top: -10px;
        }
        10% {
            opacity: 1;
        }
        90% {
            opacity: 1;
        }
        100% {
            opacity: 0;
            top: 110%;
        }
    }

    @keyframes blueShimmer {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
    }

    @keyframes redShimmer {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
    }

    /* ËÅäÂ§©ËÆ∞ÂΩïÊªöÂä®Êù°Ê†∑Âºè */
    .chat-container::-webkit-scrollbar {
        width: 8px;
        background-color: #f1f1f1;
    }

    .chat-container::-webkit-scrollbar-thumb {
        border-radius: 10px;
        background-color: #007bff;
    }

    .chat-container::-webkit-scrollbar-thumb:hover {
        background-color: #0056b3;
    }

    /* ÂìçÂ∫îÂºèÂ∏ÉÂ±ÄË∞ÉÊï¥ */
    @media (max-width: 768px) {
        .container-fluid {
            padding: 0.5rem;
        }

        .row {
            margin: 0;
        }

        .col-lg-3,
        .col-lg-6,
        .col-md-4,
        .col-md-8 {
            padding: 0.5rem;
        }

        .card {
            margin-bottom: 0.5rem;
        }

        .card-body {
            padding: 0.5rem;
        }

        .table {
            font-size: 0.8rem;
        }

        .btn-group {
            width: 100%;
        }

        .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .sidebar {
            max-height: none;
            overflow-y: visible;
        }

        .decorative-border {
            margin-bottom: 0.5rem;
        }

        .vote-info {
            padding: 0.5rem;
            margin: 0.5rem 0;
        }

        .vote-badge {
            font-size: 0.7rem;
            margin: 1px;
        }

        .message-wrapper {
            max-width: 90%;
        }

        .player-tag {
            font-size: 0.7rem;
        }

        .speech-badge,
        .hearers-tags {
            font-size: 0.6rem;
        }

        .card-footer {
            padding: 0.5rem;
        }

        .card-footer .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        #mainView .row {
            margin: 0;
        }

        #mainView .col-lg-8,
        #mainView .col-lg-4 {
            padding: 0.5rem;
        }

        #mainView .card {
            margin-bottom: 0.5rem;
        }
    }
    </style>
{% endblock styles %}
{% block content %}
    <!-- ÂºÄÂú∫Âä®Áîª -->
    <div class="intro-animation" id="introAnimation">
        <div class="intro-content">
            <h1 class="intro-title">ÈòøÁì¶ÈöÜ</h1>
            <p class="intro-subtitle">ÂØπÂ±ÄÈáçÊîæ</p>
            <div class="loading-bar">
                <div class="loading-progress"></div>
            </div>
        </div>
    </div>
    <!-- ÁßªÂä®Á´ØÂØºËà™ÂàáÊç¢ÊåâÈíÆ -->
    <div class="d-lg-none mb-2">
        <div class="btn-group w-100" role="group">
            <button type="button" class="btn btn-outline-primary active" data-view="main">Ê∏∏ÊàèËøõÁ®ã</button>
            <button type="button" class="btn btn-outline-primary" data-view="info">Ê∏∏Êàè‰ø°ÊÅØ</button>
        </div>
    </div>
    <div class="container-fluid mt-3">
        <div class="row">
            <!-- Â∑¶‰æßËæπÊ†èÔºöÊ∏∏Êàè‰ø°ÊÅØÂíåËßíËâ≤ÂàóË°® -->
            <div class="col-lg-3 col-md-4 mobile-view" id="infoView">
                <div class="sidebar">
                    <!-- Ê∏∏Êàè‰ø°ÊÅØÂç°Áâá -->
                    <div class="decorative-border">
                        <div class="card shadow-sm mb-0">
                            <div class="card-header bg-primary text-white py-2">
                                <h5 class="mb-0 fs-6">ÂØπÂ±Ä‰ø°ÊÅØ</h5>
                            </div>
                            <div class="card-body p-2">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center py-1 px-0">
                                        <small>Ê∏∏ÊàèID</small>
                                        <span class="badge bg-secondary rounded-pill">{{ game_id }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center py-1 px-0">
                                        <small>Áä∂ÊÄÅ</small>
                                        <span class="badge rounded-pill {% if game_info.winner == 'blue' %}bg-info text-dark{% elif game_info.winner == 'red' %}bg-danger{% else %}bg-secondary{% endif %}">
                                            {{ "ËìùÊñπËÉúÂà©" if game_info.winner == "blue" else ("Á∫¢ÊñπËÉúÂà©" if game_info.winner == "red" else "Êú™ÁªìÊùü") }}
                                        </span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center py-1 px-0">
                                        <small>ÂéüÂõ†</small>
                                        <small class="text-muted text-end">{{ game_info.win_reason | truncate(30) }}</small>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center py-1 px-0">
                                        <small>ÂºÄÂßãÊó∂Èó¥</small>
                                        <small class="text-muted">{{ game_info.start_time_formatted }}</small>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center py-1 px-0">
                                        <small>ÁªìÊùüÊó∂Èó¥</small>
                                        <small class="text-muted">{{ game_info.end_time_formatted }}</small>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center py-1 px-0">
                                        <small>Êó∂Èïø</small>
                                        <small class="text-muted">{{ game_info.duration }}</small>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center py-1 px-0">
                                        <small>ÊúÄÁªàÂæóÂàÜ</small>
                                        <div>
                                            <span class="badge bg-info text-dark me-1">{{ game_info.blue_wins }}</span>
                                            <span class="badge bg-danger">{{ game_info.red_wins }}</span>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <!-- ËßíËâ≤ÂàóË°® -->
                    <div class="decorative-border">
                        <div class="card shadow-sm mb-0">
                            <div class="card-header bg-primary text-white py-2">
                                <h5 class="mb-0 fs-6">ËßíËâ≤ÂàóË°® ({{ game_info.player_count }}‰∫∫)</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped table-bordered mb-0 small">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Áé©ÂÆ∂</th>
                                                <th>Áî®Êà∑Âêç</th>
                                                <th>ËßíËâ≤</th>
                                                <th>ÈòµËê•</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for player_id, role in game_info.roles.items() | sort %}
                                                {% set player_id_str = player_id | string %}
                                                <tr>
                                                    <td class="text-center">{{ player_id_str }}</td>
                                                    {% if player_usernames %}
                                                        <td>{{ player_usernames[player_id|int - 1] }}</td>
                                                    {% else %}
                                                        <td>Êú™Áü•</td>
                                                    {% endif %}
                                                    <td>
                                                        {% set role_name = role %}
                                                        {% set is_blue = role in ["Merlin", "Percival", "Knight"] %}
                                                        {% if role == "Merlin" %}
                                                            Ê¢ÖÊûó
                                                        {% elif role == "Percival" %}
                                                            Ê¥æË•øÁª¥Â∞î
                                                        {% elif role == "Knight" %}
                                                            È™ëÂ£´
                                                        {% elif role == "Assassin" %}
                                                            Âà∫ÂÆ¢
                                                        {% elif role == "Morgana" %}
                                                            Ëé´ÁîòÂ®ú
                                                        {% elif role == "Mordred" %}
                                                            Ëé´Âæ∑Èõ∑Âæ∑
                                                        {% elif role == "Oberon" %}
                                                            Â••‰ºØ‰º¶
                                                        {% else %}
                                                            {{ role }}
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-center">
                                                        {% if is_blue %}
                                                            <span class="badge bg-info text-dark">ËìùÊñπ</span>
                                                        {% else %}
                                                            <span class="badge bg-danger">Á∫¢Êñπ</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                            {% else %}
                                                <tr>
                                                    <td colspan="4" class="text-center text-muted">ËßíËâ≤‰ø°ÊÅØ‰∏çÂèØÁî®</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ‰∏≠Â§ÆÔºöËÅäÂ§©ËÆ∞ÂΩï‰∏ª‰ΩìÂíåÂú∞Âõæ -->
            <div class="col-lg-9 col-md-8 mobile-view" id="mainView">
                <div class="row">
                    <!-- ËÅäÂ§©ËÆ∞ÂΩï -->
                    <div class="col-lg-8">
                        <div class="card shadow-sm">
                            <div class="card-header bg-primary text-white py-2 d-flex justify-content-between align-items-center">
                                <h4 class="mb-0 fs-6">ÂØπÂ±ÄÊµÅÁ®ã</h4>
                                <span class="badge bg-light text-dark" id="currentRoundBadge">ÂàùÂßãÁä∂ÊÄÅ</span>
                            </div>
                            <div class="card-body p-0">
                                <div class="chat-container" id="chatContainer">
                                    <!-- ÂàùÂßãÂåñÊèêÁ§∫ -->
                                    <div class="text-center my-5 text-muted">
                                        <i class="bi bi-hourglass-split" style="font-size: 2rem;"></i>
                                        <p>Âä†ËΩΩÂØπÂ±ÄÊµÅÁ®ã‰∏≠...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Ëá™Âä®Ë∑≥Âä®ÂõûÊîæ</small>
                                    <div>
                                        <button class="btn btn-sm btn-outline-secondary"
                                                id="scrollToBottomBtn"
                                                title="ÊªöÂä®Âà∞Â∫ïÈÉ®">
                                            <i class="bi bi-arrow-down-circle"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-info ms-1"
                                                id="manualNextBtn"
                                                title="ÊâãÂä®‰∏ã‰∏ÄÊ≠•">
                                            <i class="bi bi-skip-end-fill"></i>
                                        </button>
                                        <button type="button"
                                                class="btn btn-sm btn-outline-primary ms-2"
                                                id="autoplayBtnFlow">
                                            <i class="bi bi-play-fill"></i> Ëá™Âä®Êí≠Êîæ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Ê∏∏ÊàèÂú∞Âõæ -->
                    <div class="col-lg-4">
                        <div class="card shadow-sm">
                            <div class="card-header bg-primary text-white py-2 d-flex justify-content-between align-items-center">
                                <h5 class="mb-0 fs-6">Ê∏∏ÊàèÂú∞Âõæ</h5>
                                <span class="badge bg-light text-dark" id="mapCurrentRoundDisplay">ÂàùÂßãÁä∂ÊÄÅ</span>
                            </div>
                            <div class="card-body p-2">
                                <div class="game-map" id="gameMap">
                                    <div class="text-center text-muted p-3 small">Âú∞ÂõæÂä†ËΩΩ‰∏≠...</div>
                                </div>
                            </div>
                            <div class="card-footer text-center p-2">
                                <div class="btn-group w-100" role="group">
                                    <button type="button"
                                            class="btn btn-sm btn-outline-secondary"
                                            id="mapPrevRoundBtn"
                                            disabled>
                                        <i class="bi bi-chevron-left"></i> ‰∏ä‰∏ÄËΩÆ
                                    </button>
                                    <button type="button"
                                            class="btn btn-sm btn-outline-secondary"
                                            id="mapNextRoundBtn">
                                        ‰∏ã‰∏ÄËΩÆ <i class="bi bi-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}
{% block scripts %}
    {{ super() }}
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Ëá™Âä®ÈÄêÊù°Ë∑≥Âä®ÂõûÊîæ ---
        let isAutoReplay = false;
        let autoReplayTimeout = null;
        let currentReplayMsgIndex = 0; // ÂΩìÂâçÊí≠Êîæ‰ΩçÁΩÆÔºå‰∏çÂÜçÈáçÁΩÆ‰∏∫0

        function getAllReplayMessages() {
            return Array.from(chatContainer.querySelectorAll('.message-bubble, .message-system, .move-message'));
        }

        function getMessageDelay(msgElem) {
            let text = '';
            let baseDelay = 1000;
            
            if (msgElem.classList.contains('message-bubble')) {
                text = msgElem.innerText || msgElem.textContent || '';
                baseDelay = 1500;
            } else if (msgElem.classList.contains('message-system')) {
                text = msgElem.innerText || msgElem.textContent || '';
                baseDelay = 800;
            } else if (msgElem.classList.contains('move-message')) {
                text = msgElem.innerText || msgElem.textContent || '';
                baseDelay = 600;
            }
            
            // ËÆ°ÁÆóÊñáÊú¨ÈïøÂ∫¶Ôºà‰∏≠ÊñáÂ≠óÁ¨¶ÂíåËã±ÊñáÂ≠óÁ¨¶ÂàÜÂà´ËÆ°ÁÆóÔºâ
            const chineseChars = (text.match(/[\u4e00-\u9fa5]/g) || []).length;
            const otherChars = text.length - chineseChars;
            
            // ‰∏≠ÊñáÂ≠óÁ¨¶ÈòÖËØªÊó∂Èó¥Êõ¥Èïø
            const chineseReadTime = chineseChars * 120; // ÊØè‰∏™‰∏≠ÊñáÂ≠óÁ¨¶120ms
            const otherReadTime = otherChars * 40;      // ÊØè‰∏™ÂÖ∂‰ªñÂ≠óÁ¨¶40ms
            
            // ËÆ°ÁÆóÊÄªÂª∂ËøüÊó∂Èó¥
            let totalDelay = baseDelay + chineseReadTime + otherReadTime;
            
            // Ê†πÊçÆÊ∂àÊÅØÁ±ªÂûãË∞ÉÊï¥ËåÉÂõ¥
            if (msgElem.classList.contains('message-bubble')) {
                totalDelay = Math.max(1500, Math.min(6000, totalDelay));
            } else if (msgElem.classList.contains('message-system')) {
                totalDelay = Math.max(800, Math.min(4000, totalDelay));
            } else if (msgElem.classList.contains('move-message')) {
                totalDelay = Math.max(600, Math.min(2000, totalDelay));
            } else {
                totalDelay = Math.max(500, Math.min(5000, totalDelay));
            }
            
            return totalDelay;
        }

        // ÊâãÂä®‰∏ã‰∏ÄÊ≠•ÂäüËÉΩ
        function manualNextStep() {
            const messages = getAllReplayMessages();
            if (currentReplayMsgIndex >= messages.length) {
                currentReplayMsgIndex = messages.length - 1;
                return;
            }
            
            // ÂÅúÊ≠¢Ëá™Âä®Êí≠Êîæ
            if (isAutoReplay) {
                stopAutoReplay();
            }
            
            // ÊâßË°å‰∏ã‰∏ÄÊ≠•
            executeReplayStep(messages);
            currentReplayMsgIndex++;
            
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            updateManualButtons(messages.length);
        }

        // ÊâßË°åÊí≠ÊîæÊ≠•È™§ÔºàÂàÜÁ¶ªÂá∫Êù•‰æõËá™Âä®ÂíåÊâãÂä®ÂÖ±Áî®Ôºâ
        function executeReplayStep(messages) {
            if (currentReplayMsgIndex >= messages.length) {
                return false;
            }
            
            const msg = messages[currentReplayMsgIndex];
            
            // ÊªöÂä®Âà∞ÂΩìÂâçÊ∂àÊÅØ
            msg.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // ÁßªÈô§‰πãÂâçÁöÑÈ´ò‰∫Æ
            messages.forEach(m => m.classList.remove('auto-replay-active'));
            msg.classList.add('auto-replay-active');

            // Â¶ÇÊûúÊòØÁßªÂä®Ê∂àÊÅØÔºåÊõ¥Êñ∞Âú∞Âõæ
            if (msg.classList.contains('move-message')) {
                const moveIndex = parseInt(msg.dataset.moveIndex);
                if (!isNaN(moveIndex)) {
                    renderMapByMoveIndex(moveIndex);
                }
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÊòØÂà∫ÊùÄÊàêÂäüÊ∂àÊÅØ
            checkForAssassinationSuccess(msg);
            
            // Ê£ÄÊü•ÊòØÂê¶ÊòØËÉúÂà©Ê∂àÊÅØ
            checkForVictory(msg);
            
            return true;
        }

        // ‰øÆÂ§ç checkForAssassinationSuccess ÂáΩÊï∞ - ‰øùÁïôËá™Âä®Êí≠ÊîæÊó∂ÁöÑÂä®ÁîªËß¶Âèë
        function checkForAssassinationSuccess(msgElement) {
            const text = msgElement.textContent || msgElement.innerText || '';
            
            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´Âà∫ÊùÄÊàêÂäüÁöÑ‰ø°ÊÅØ
            if (text.includes('Âà∫ÊùÄ') && text.includes('ÊàêÂäü')) {
                console.log('Ê£ÄÊµãÂà∞Âà∫ÊùÄÊàêÂäüÊ∂àÊÅØÔºåÂáÜÂ§áÊí≠ÊîæÂä®Áîª');
                
                // Âª∂ËøüÊí≠ÊîæÂä®ÁîªÔºåËÆ©Áî®Êà∑ÂÖàÁúãÂà∞Âà∫ÊùÄÁªìÊûú
                setTimeout(() => {
                    // ‰ªéÂÖ®Â±ÄÊ∏∏ÊàèÊï∞ÊçÆ‰∏≠ÊâæÂà∞Âà∫ÊùÄ‰ø°ÊÅØ
                    const assassinationEvent = gameEvents.find(event => 
                        event.round === 'assassination' && event.assassination && event.assassination.success
                    );
                    
                    if (assassinationEvent) {
                        const assassinInfo = getPlayerInfo(assassinationEvent.assassination.assassin);
                        const targetInfo = getPlayerInfo(assassinationEvent.assassination.target);
                        showAssassinationSuccessAnimation(assassinInfo, targetInfo, assassinationEvent.assassination.target_role);
                    }
                }, 1000);
            }
        }

        // Âú® checkForAssassinationSuccess ÂáΩÊï∞ÂêéÊ∑ªÂä†ËÉúÂà©Ê£ÄÊµã
        function checkForVictory(msgElement) {
            const text = msgElement.textContent || msgElement.innerText || '';
            
            if (text.includes('ËÉúÂà©')) {
                setTimeout(function() {
                    if (text.includes('ËìùÊñπËÉúÂà©')) {
                        showVictoryBanner('blue', 'üîµ ËìùÊñπËÉúÂà©', 'Ê≠£‰πâ‰∏éÊô∫ÊÖßÁöÑËÉúÂà©', gameInfo.win_reason);
                    } else if (text.includes('Á∫¢ÊñπËÉúÂà©')) {
                        showVictoryBanner('red', 'üî¥ Á∫¢ÊñπËÉúÂà©', 'Èò¥Ë∞ã‰∏éËÉåÂèõÁöÑËÉúÂà©', gameInfo.win_reason);
                    }
                }, 800);
            }
        }

        // Ê∑ªÂä†ÂÖ®Â±ÄÂÖ≥Èó≠ËÉúÂà©Ê®™ÂπÖÂáΩÊï∞
        window.closeVictoryBanner = function() {
            const banner = document.querySelector('.victory-banner');
            if (banner) {
                banner.style.animation = 'victorySlideOut 0.8s ease forwards';
                setTimeout(() => {
                    banner.remove();
                }, 800);
            }
        };

        // ÊòæÁ§∫ËÉúÂà©Ê®™ÂπÖ
        function showVictoryBanner(faction, title, subtitle, reason) {
            // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÊ®™ÂπÖ
            const existingBanner = document.querySelector('.victory-banner');
            if (existingBanner) {
                existingBanner.remove();
            }
            
            const victoryBanner = document.createElement('div');
            victoryBanner.className = 'victory-banner ' + faction;
            
            // ÁîüÊàêÁ≤íÂ≠êÊïàÊûú
            let particlesHtml = '';
            for (let i = 0; i < 15; i++) {
                const left = Math.random() * 100;
                const delay = Math.random() * 2;
                particlesHtml += '<div class="victory-particle" style="left: ' + left + '%; animation-delay: ' + delay + 's;"></div>';
            }
            
            // ÊûÑÂª∫Ê®™ÂπÖÂÜÖÂÆπ
            let html = '<div class="victory-particles">' + particlesHtml + '</div>';
            html += '<div class="victory-icon left">‚öîÔ∏è</div>';
            html += '<div class="victory-icon right">üèÜ</div>';
            html += '<div class="victory-content">';
            html += '<h1 class="victory-title">' + title + '</h1>';
            html += '<p class="victory-subtitle">' + subtitle + '</p>';
            html += '<p class="victory-reason">' + (reason || 'Ê∏∏ÊàèÁªìÊùü') + '</p>';
            html += '</div>';
            
            // ÂàõÂª∫ÂÖ≥Èó≠ÊåâÈíÆ - ‰øÆÂ§ç‰∫ã‰ª∂ÁõëÂê¨Âô®
            const closeBtn = document.createElement('button');
            closeBtn.className = 'victory-close-btn';
            closeBtn.innerHTML = '‚úï';
            closeBtn.title = 'ÂÖ≥Èó≠';
            closeBtn.style.opacity = '0';
            closeBtn.style.animation = 'victoryCloseAppear 0.5s ease 2.5s forwards';
            
            // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÁõëÂê¨Âô®
            closeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                closeVictoryBanner();
            });
            
            victoryBanner.innerHTML = html;
            victoryBanner.appendChild(closeBtn);
            
            // Ê∑ªÂä†ÁÇπÂáªÊ®™ÂπÖÂ§ñÈÉ®‰πüËÉΩÂÖ≥Èó≠ÁöÑÂäüËÉΩ
            victoryBanner.addEventListener('click', function(e) {
                if (e.target === victoryBanner) {
                    closeVictoryBanner();
                }
            });
            
            document.body.appendChild(victoryBanner);
            
            // Êí≠ÊîæËÉúÂà©Èü≥Êïà
            playVictorySound(faction);
            
            // 8ÁßíÂêéËá™Âä®ÂÖ≥Èó≠
            setTimeout(function() {
                if (document.querySelector('.victory-banner')) {
                    closeVictoryBanner();
                }
            }, 8000);
        }

        // ÂÆö‰πâÂÖ®Â±ÄÂÖ≥Èó≠ÂáΩÊï∞
        function closeVictoryBanner() {
            const banner = document.querySelector('.victory-banner');
            if (banner) {
                banner.style.animation = 'victorySlideOut 0.8s ease forwards';
                setTimeout(() => {
                    banner.remove();
                }, 800);
            }
        }

        // Â∞ÜÂáΩÊï∞ÊåÇËΩΩÂà∞windowÂØπË±°‰ª•‰æøÂÖ®Â±ÄËÆøÈóÆ
        window.closeVictoryBanner = closeVictoryBanner;

        // Êí≠ÊîæËÉúÂà©Èü≥Êïà
        function playVictorySound(faction) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                if (faction === 'blue') {
                    // ËìùÊñπÔºöÊòé‰∫Æ‰∏äÂçáÁöÑÈü≥Ë∞É
                    playTone(audioContext, 523.25, 0.3, 0);    // C5
                    playTone(audioContext, 659.25, 0.3, 0.2);  // E5
                    playTone(audioContext, 783.99, 0.4, 0.4);  // G5
                } else {
                    // Á∫¢ÊñπÔºö‰ΩéÊ≤âÊúâÂäõÁöÑÈü≥Ë∞É
                    playTone(audioContext, 293.66, 0.4, 0);    // D4
                    playTone(audioContext, 369.99, 0.4, 0.2);  // F#4
                    playTone(audioContext, 440.00, 0.5, 0.4);  // A4
                }
            } catch (error) {
                console.log('ËÉúÂà©Èü≥ÊïàÊí≠ÊîæÂ§±Ë¥•:', error);
            }
        }

        function playTone(audioContext, frequency, duration, delay) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime + delay);
            gainNode.gain.setValueAtTime(0, audioContext.currentTime + delay);
            gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + delay + 0.1);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + delay + duration);
            
            oscillator.start(audioContext.currentTime + delay);
            oscillator.stop(audioContext.currentTime + delay + duration);
        }

        // Ê∑ªÂä†Áº∫Â§±ÁöÑËá™Âä®Êí≠ÊîæÁõ∏ÂÖ≥ÂáΩÊï∞
        function startAutoReplay() {
            if (isAutoReplay) return;
            
            isAutoReplay = true;
            autoplayBtnFlow.innerHTML = '<i class="bi bi-pause-fill"></i> ÊöÇÂÅúÊí≠Êîæ';
            autoplayBtnFlow.classList.remove('btn-outline-primary');
            autoplayBtnFlow.classList.add('btn-primary');
            
            console.log('ÂºÄÂßãËá™Âä®Êí≠ÊîæÔºåÂΩìÂâçÁ¥¢Âºï:', currentReplayMsgIndex);
            
            const messages = getAllReplayMessages();
            if (currentReplayMsgIndex >= messages.length) {
                currentReplayMsgIndex = 0; // ÈáçÊñ∞ÂºÄÂßã
            }
            
            // ÂºÄÂßãÊí≠ÊîæÂæ™ÁéØ
            playNextMessage(messages);
        }

        function stopAutoReplay() {
            if (!isAutoReplay) return;
            
            isAutoReplay = false;
            if (autoReplayTimeout) {
                clearTimeout(autoReplayTimeout);
                autoReplayTimeout = null;
            }
            
            autoplayBtnFlow.innerHTML = '<i class="bi bi-play-fill"></i> Ëá™Âä®Êí≠Êîæ';
            autoplayBtnFlow.classList.remove('btn-primary');
            autoplayBtnFlow.classList.add('btn-outline-primary');
            
            console.log('ÂÅúÊ≠¢Ëá™Âä®Êí≠ÊîæÔºåÂΩìÂâçÁ¥¢Âºï:', currentReplayMsgIndex);
        }

        function playNextMessage(messages) {
            if (!isAutoReplay || currentReplayMsgIndex >= messages.length) {
                if (currentReplayMsgIndex >= messages.length) {
                    console.log('Ëá™Âä®Êí≠ÊîæÂÆåÊàê');
                }
                stopAutoReplay();
                return;
            }
            
            const success = executeReplayStep(messages);
            if (!success) {
                stopAutoReplay();
                return;
            }
            
            const currentMsg = messages[currentReplayMsgIndex];
            const delay = getMessageDelay(currentMsg);
            
            currentReplayMsgIndex++;
            updateManualButtons(messages.length);
            
            // ËÆæÁΩÆ‰∏ã‰∏ÄÊù°Ê∂àÊÅØÁöÑÊí≠ÊîæÂÆöÊó∂Âô®
            autoReplayTimeout = setTimeout(() => {
                playNextMessage(messages);
            }, delay);
        }

        // Ê∑ªÂä†Êõ¥Êñ∞ÊâãÂä®ÊåâÈíÆÁä∂ÊÄÅÁöÑÂáΩÊï∞
        function updateManualButtons(totalMessages) {
            if (manualNextBtn) {
                if (currentReplayMsgIndex >= totalMessages) {
                    manualNextBtn.disabled = true;
                    manualNextBtn.innerHTML = '<i class="bi bi-check-circle"></i> Â∑≤ÂÆåÊàê';
                } else {
                    manualNextBtn.disabled = false;
                    manualNextBtn.innerHTML = '<i class="bi bi-skip-end-fill"></i> ‰∏ã‰∏ÄÊ≠•';
                }
            }
        }

        // Ê∑ªÂä†Áº∫Â§±ÁöÑÂä®ÁîªÂÖ≥ÈîÆÂ∏ßCSS
        const animationCSS = `
        @keyframes assassinationFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes assassinationFadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        @keyframes assassinationTitleAppear {
            0% {
                opacity: 0;
                transform: scale(0.3) translateY(50px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        @keyframes assassinationSubtitleAppear {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes assassinationDetailsAppear {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes bloodPulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.7; }
        }
        
        @keyframes daggerStrike {
            0% {
                transform: rotate(45deg) scale(0);
                opacity: 0;
            }
            50% {
                transform: rotate(45deg) scale(1.2);
                opacity: 0.8;
            }
            100% {
                transform: rotate(45deg) scale(1);
                opacity: 1;
            }
        }
        
        @keyframes crownAppear {
            0% {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        
        @keyframes closeButtonAppear {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.5);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        `;
        
        // Â∞ÜÂä®ÁîªCSSÊ∑ªÂä†Âà∞È°µÈù¢
        const styleSheet = document.createElement('style');
        styleSheet.textContent = animationCSS;
        document.head.appendChild(styleSheet);

        // ÁßªÂä®Á´ØËßÜÂõæÂàáÊç¢
        const viewButtons = document.querySelectorAll('[data-view]');
        const views = document.querySelectorAll('.mobile-view');

        function switchView(viewName) {
            views.forEach(view => {
                if (view.id === viewName + 'View') {
                    view.style.display = 'block';
                } else {
                    view.style.display = 'none';
                }
            });

            viewButtons.forEach(btn => {
                if (btn.dataset.view === viewName) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        viewButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                switchView(btn.dataset.view);
            });
        });

        // ÂàùÂßãÂåñ
        if (window.innerWidth <= 768) {
            switchView('main');
        }

        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                views.forEach(view => {
                    view.style.display = '';
                });
            }
        });

        // ÂºÄÂú∫Âä®Áîª
        setTimeout(() => {
            const introAnimation = document.getElementById('introAnimation');
            if (introAnimation) {
                introAnimation.classList.add('fade-out');
                setTimeout(() => {
                    introAnimation.style.display = 'none';
                }, 500);
            }
        }, 3000);

        // --- Data from Flask ---
        const gameEvents = {{ game_events|tojson }};
        const playerMovements = {{ player_movements|tojson }};
        const gameInfo = {{ game_info|tojson }};
        const roles = gameInfo.roles || {};
        const mapSize = {{ map_size }};
        const gameId = "{{ game_id }}";

        // Determine max round from events or score
        const maxRoundFromEvents = gameEvents.length > 0
            ? (gameEvents[gameEvents.length - 1].round === 'assassination'
                ? (gameEvents.length > 1 ? gameEvents[gameEvents.length - 2].round : 0)
                : gameEvents[gameEvents.length - 1].round)
            : 0;
        const maxRound = Math.max(maxRoundFromEvents, gameInfo.rounds_played || 0);

        // --- Role Info ---
        const roleNames = {
            "Merlin": "Ê¢ÖÊûó", "Percival": "Ê¥æË•øÁª¥Â∞î", "Knight1": "È™ëÂ£´", "Knight2": "È™ëÂ£´",
            "Assassin": "Âà∫ÂÆ¢", "Morgana": "Ëé´ÁîòÂ®ú", "Oberon": "Â••‰ºØ‰º¶"
        };
        const roleFactions = {
            "Merlin": "blue", "Percival": "blue", "Knight1": "blue", "Knight2": "blue",
            "Assassin": "red", "Morgana": "red", "Oberon": "red"
        };

        // Áî®‰∫éË∑üË∏™È™ëÂ£´ÂàÜÈÖç
        let knightCount = 0;
        const knightAssignments = new Map();

        // --- DOM Elements ---
        const chatContainer = document.getElementById('chatContainer');
        const gameMapContainer = document.getElementById('gameMap');
        const currentRoundBadge = document.getElementById('currentRoundBadge');
        const autoplayBtnFlow = document.getElementById('autoplayBtnFlow');
        const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');
        const mapPrevRoundBtn = document.getElementById('mapPrevRoundBtn');
        const mapNextRoundBtn = document.getElementById('mapNextRoundBtn');
        const mapCurrentRoundDisplay = document.getElementById('mapCurrentRoundDisplay');

        let currentMapRound = 0;

        // --- Helper Functions ---
        function getPlayerInfo(playerId) {
            const idStr = String(playerId);
            let role = roles[idStr] || 'Êú™Áü•ËßíËâ≤';
            if (role === 'Knight') {
                if (!knightAssignments.has(idStr)) {
                    knightCount++;
                    knightAssignments.set(idStr, knightCount);
                }
                role = knightAssignments.get(idStr) === 1 ? 'Knight1' : 'Knight2';
            }
            const name = roleNames[role] || role;
            const faction = roleFactions[role] || 'unknown';
            return { id: idStr, role: role, name: name, faction: faction };
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function initializeKnightAssignments() {
            knightCount = 0;
            knightAssignments.clear();
            const knightIds = Object.entries(roles)
                .filter(([_, role]) => role === 'Knight')
                .map(([id, _]) => parseInt(id))
                .sort((a, b) => a - b);

            knightIds.forEach((id, index) => {
                knightAssignments.set(id.toString(), index + 1);
            });
        }

        initializeKnightAssignments();

        // --- ÊâπÊ¨°ÁßªÂä®Êï∞ÊçÆÁªìÊûÑ ---
        let moveSteps = [];
        let moveIndexToRound = [];
        let moveIndexToMsgId = [];
        let msgIdToMoveIndex = {};

        // --- È¢ÑÂ§ÑÁêÜÊâÄÊúâÁßªÂä®‰∫ã‰ª∂ÔºåÁîüÊàêmoveSteps ---
        function preprocessMoveSteps() {
            moveSteps = [];
            moveIndexToRound = [];
            moveIndexToMsgId = [];
            msgIdToMoveIndex = {};
            let moveIndex = 0;
            let msgId = 0;
            gameEvents.forEach((event) => {
                if (event.round === 'assassination') return;
                if (event.events && event.events.length > 0) {
                    event.events.forEach(eventItem => {
                        if (eventItem.type === "move") {
                            moveSteps.push({
                                moveIndex,
                                round: event.round,
                                playerId: eventItem.data.player_id,
                                move: eventItem.data.valid_moves[eventItem.data.valid_moves.length - 1],
                                newPos: eventItem.data.new_pos,
                                msgId
                            });
                            moveIndexToRound.push(event.round);
                            moveIndexToMsgId.push(msgId);
                            msgIdToMoveIndex[msgId] = moveIndex;
                            moveIndex++;
                        }
                        msgId++;
                    });
                } else {
                    if (event.events) msgId += event.events.length;
                }
            });
        }
        preprocessMoveSteps();

        // --- Âú∞ÂõæÊ∏≤ÊüìÂáΩÊï∞ ---
        function renderMapByMoveIndex(moveIdx) {
            gameMapContainer.innerHTML = '';
            let playerPos = {};

            if (true) {
                Object.entries(playerMovements).forEach(([playerId, moves]) => {
                    if (moves && moves.length > 0) {
                        const initialMove = moves.find(move => move.round === 0);
                        if (initialMove) {
                            playerPos[playerId] = initialMove.position;
                        }
                    }
                });
            }
            if (moveIdx >= 0) {
                for (let i = 0; i <= moveIdx && i < moveSteps.length; i++) {
                    const step = moveSteps[i];
                    playerPos[step.playerId] = step.newPos;
                }
            }

            let currentRound = moveIdx >= 0 && moveIdx < moveSteps.length ? moveSteps[moveIdx].round : 0;
            currentMapRound = currentRound;

            mapPrevRoundBtn.disabled = currentRound <= 0;
            mapNextRoundBtn.disabled = currentRound >= maxRound;

            for (let r = 0; r < mapSize; r++) {
                for (let c = 0; c < mapSize; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('map-cell');
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    gameMapContainer.appendChild(cell);
                }
            }

            Object.keys(playerPos).forEach(playerId => {
                const pos = playerPos[playerId];
                if (pos && Array.isArray(pos) && pos.length === 2) {
                    const [row, col] = pos;
                    if (row >= 0 && row < mapSize && col >= 0 && col < mapSize) {
                        const cell = gameMapContainer.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                        if (cell) {
                            const playerInfo = getPlayerInfo(playerId);
                            const playerToken = document.createElement('div');
                            playerToken.classList.add('player-token', `player-${playerInfo.faction}`);
                            playerToken.textContent = playerInfo.id;
                            playerToken.title = `${playerInfo.id}Âè∑ - ${playerInfo.name}`;
                            cell.appendChild(playerToken);
                        }
                    }
                }
            });

            if (moveIdx >= 0) {
                const step = moveSteps[moveIdx];
                mapCurrentRoundDisplay.textContent = `Á¨¨${step.round}ËΩÆ-Á¨¨${moveIdx + 1}Ê≠•`;
            } else {
                mapCurrentRoundDisplay.textContent = 'ÂàùÂßãÁä∂ÊÄÅ';
            }
            currentRoundBadge.textContent = mapCurrentRoundDisplay.textContent;
        }

        // --- ËÅäÂ§©ÂéÜÂè≤ÁîüÊàê ---
        function generateChatHistory() {
            let chatHtml = '';
            let msgId = 0;
            let moveCount = 0;

            chatHtml += `
                <div class="round-divider" id="round-0">
                    <span class="badge bg-secondary">Ê∏∏ÊàèÂºÄÂßã</span>
                </div>
                <div class="message-system">
                    ÂºÄÂßã‰∫é: ${gameInfo.start_time_formatted || 'Êú™Áü•Êó∂Èó¥'}
                </div>
            `;

            gameEvents.forEach((event) => {
                if (event.round === 'assassination') {
                    chatHtml += `
                        <div class="round-divider" id="round-assassination">
                            <span class="badge bg-dark">Âà∫ÊùÄÈò∂ÊÆµ</span>
                        </div>`;
                    if (event.assassination) {
                        const assassinInfo = getPlayerInfo(event.assassination.assassin);
                        const targetInfo = getPlayerInfo(event.assassination.target);
                        const isSuccess = event.assassination.success;
                        
                        chatHtml += `
                            <div class="message-system">
                                Âà∫ÂÆ¢ ${assassinInfo.id}Âè∑ (${assassinInfo.name}) ÈÄâÊã©Âà∫ÊùÄ ${targetInfo.id}Âè∑ (${targetInfo.name} - ${event.assassination.target_role}).<br>
                                ÁªìÊûú: <span class="badge ${isSuccess ? 'bg-danger' : 'bg-success'}">${isSuccess ? 'ÊàêÂäü' : 'Â§±Ë¥•'}</span>
                            </div>`;
                        
                        // Ê≥®ÈáäÊéâÂàùÂßãÂåñÊó∂ÁöÑÂà∫ÊùÄÂä®Áîª
                        // if (isSuccess) {
                        //     setTimeout(() => {
                        //         showAssassinationSuccessAnimation(assassinInfo, targetInfo, event.assassination.target_role);
                        //     }, 1000); // Âª∂Ëøü1ÁßíÊòæÁ§∫Âä®ÁîªÔºåËÆ©Áî®Êà∑ÂÖàÁúãÂà∞Âà∫ÊùÄÁªìÊûú
                        // }
                    }
                    return;
                }

                const roundNum = event.round;
                const missionSuccess = event.mission_result ? event.mission_result.success : null;
                const roundBadgeClass = missionSuccess === true ? 'bg-info text-dark' : (missionSuccess === false ? 'bg-danger' : 'bg-secondary');
                const roundResultText = missionSuccess === true ? 'ÊàêÂäü' : (missionSuccess === false ? 'Â§±Ë¥•' : 'ËøõË°å‰∏≠');

                chatHtml += `
                    <div class="round-divider" id="round-${roundNum}">
                        <span class="badge ${roundBadgeClass}">
                            Á¨¨ ${roundNum} ËΩÆ‰ªªÂä° ${missionSuccess !== null ? `(${roundResultText})` : ''}
                        </span>
                    </div>
                `;

                if (event.leader) {
                    const leaderInfo = getPlayerInfo(event.leader);
                    chatHtml += `
                        <div class="message-system">
                            <i class="bi bi-person-badge"></i> <strong>ÈòüÈïø:</strong> ${leaderInfo.id}Âè∑ (${leaderInfo.name})<br>
                            <i class="bi bi-people-fill"></i> <strong>ÊèêËÆÆÈòü‰ºç:</strong>
                            ${event.team_members && event.team_members.length > 0
                                ? event.team_members.map(memberId => `<span class="badge bg-secondary mx-1">${getPlayerInfo(memberId).id}Âè∑</span>`).join('')
                                : 'Êó†'}
                        </div>
                    `;
                } else {
                    chatHtml += `<div class="message-system">Á≠âÂæÖÈòüÈïø ${event.leader || '?'}Âè∑ ÈÄâÊã©Èòü‰ºç...</div>`;
                }

                if (event.events && event.events.length > 0) {
                    event.events.forEach(eventItem => {
                        if (eventItem.type === "team_propose") {
                            const leader = eventItem.data.leader;
                            const team_members = eventItem.data.team_members;
                            if (leader) {
                                const leaderInfo = getPlayerInfo(leader);
                                chatHtml += `
                                    <div class="message-system">
                                        <i class="bi bi-person-badge"></i> <strong>ÈòüÈïø:</strong> ${leaderInfo.id}Âè∑ (${leaderInfo.name})<br>
                                        <i class="bi bi-people-fill"></i> <strong>ÊèêËÆÆÈòü‰ºç:</strong>
                                        ${team_members && team_members.length > 0
                                            ? team_members.map(memberId => `<span class="badge bg-secondary mx-1">${getPlayerInfo(memberId).id}Âè∑</span>`).join('')
                                            : 'Êó†'}
                                    </div>
                                `;
                            }
                        } else if (eventItem.type === "move") {
                            const playerId = eventItem.data.player_id;
                            const validMoves = eventItem.data.valid_moves;
                            const lastMove = validMoves[validMoves.length - 1];
                            let lastMoveDisplay = "";

                            if (lastMove === "left") {
                                lastMoveDisplay = "‚¨ÖÔ∏è ÂêëÂ∑¶";
                            } else if (lastMove === "up") {
                                lastMoveDisplay = "‚¨ÜÔ∏è Âêë‰∏ä";
                            } else if (lastMove === "down") {
                                lastMoveDisplay = "‚¨áÔ∏è Âêë‰∏ã";
                            } else if (lastMove === "right") {
                                lastMoveDisplay = "‚û°Ô∏è ÂêëÂè≥";
                            }

                            const newPos = eventItem.data.new_pos;
                            if (playerId) {
                                moveCount++;
                                let moveIndex = msgIdToMoveIndex[msgId];
                                chatHtml += `
                                    <div class="message-system move-message" data-move-index="${moveIndex}" style="cursor: pointer;" onclick="showMoveOnMap(${moveIndex})">
                                        <i class="bi bi-person-badge"></i> <strong>${playerId}Âè∑ Áé©ÂÆ∂</strong> ËøõË°å‰∫ÜÁßªÂä®
                                        <span class="badge bg-secondary ms-2">Á¨¨${moveCount}Ê≠•</span><br>
                                        <strong>ÊúâÊïàÁßªÂä®:</strong> ${lastMoveDisplay}<br>
                                        <strong>Êñ∞‰ΩçÁΩÆ:</strong> ${newPos}
                                        <small class="text-muted d-block mt-1">üí° ÁÇπÂáªÊü•ÁúãÂú∞ÂõæÁä∂ÊÄÅ</small>
                                    </div>
                                `;
                            }
                        } else if (eventItem.type === "speech") {
                            const [playerId, message, speechType, hearers] = eventItem.data;
                            const playerInfo = getPlayerInfo(playerId);
                            const wrapperClass = playerInfo.faction === 'blue' ? 'message-wrapper-blue' : 'message-wrapper-red';
                            const tagColorClass = playerInfo.faction === 'blue' ? 'text-primary' : 'text-danger';
                            const bubbleClass = `message-${playerInfo.faction} ${speechType === "private" ? "private-speech" : ""}`;

                            const speechBadge = speechType === "private"
                                ? '<span class="badge bg-secondary speech-badge">ÊúâÈôêËåÉÂõ¥</span>'
                                : '<span class="badge bg-info text-dark speech-badge">ÂÖ¨ÂºÄ</span>';

                            const hearersTags = speechType === "private" && hearers
                                ? `<span class="badge bg-secondary speech-badge">${hearers}</span>`
                                : '';

                            const speechId = `speech-${msgId}`;
                            const ttsButtonId = `tts-btn-${msgId}`;

                            // Ëé∑ÂèñËßíËâ≤ÂØπÂ∫îÁöÑCSSÁ±ªÂêç
                            function getRoleClass(role) {
                                const roleClassMap = {
                                    'Merlin': 'role-merlin',
                                    'Percival': 'role-percival',
                                    'Knight1': 'role-knight1',
                                    'Knight2': 'role-knight2',
                                    'Assassin': 'role-assassin',
                                    'Morgana': 'role-morgana',
                                    'Oberon': 'role-oberon'
                                };
                                return roleClassMap[role] || '';
                            }

                            const roleClass = getRoleClass(playerInfo.role);
                            const avatarClasses = `player-avatar ${playerInfo.faction} ${roleClass}`;

                            chatHtml += `
                                <div class="message-wrapper ${wrapperClass}">
                                    <div class="${avatarClasses}" title="${playerInfo.id}Âè∑ - ${playerInfo.name}">
                                        ${roleClass ? '' : playerInfo.id}
                                    </div>
                                    <div class="message-content">
                                        <div class="player-tag ${tagColorClass}">
                                            ${playerInfo.id}Âè∑ (${playerInfo.name}) ${speechBadge} ${hearersTags ? `<div class="hearers-tags">${hearersTags}</div>` : ""}                     
                                        </div>
                                        <div class="message-bubble ${bubbleClass}" id="${speechId}" 
                                             data-player-id="${playerId}" 
                                             data-text="${message.replace(/"/g, '&quot;')}"
                                             data-battle-id="${gameId}">
                                            ${message}
                                            <button class="tts-play-btn" id="${ttsButtonId}" onclick="playTTS('${speechId}')" title="Êí≠ÊîæËØ≠Èü≥">
                                                <i class="bi bi-volume-up"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="clearfix"></div>
                            `;
                        } else if (eventItem.type === "vote_attempt") {
                            const voteAttempt = eventItem.data;
                            const approved = voteAttempt.approved;
                            chatHtml += `
                                <div class="vote-info">
                                    <strong>Èòü‰ºçÊäïÁ•®ÁªìÊûú:</strong>

                                    <span class="badge fs-6 ${approved ? 'bg-success' : 'bg-warning text-dark'}">
                                        ${approved ? 'ÈÄöËøá' : 'ÊãíÁªù'}
                                    </span>
                                    <small class="text-muted">(${voteAttempt.approve_count || 0} ËµûÊàê / ${voteAttempt.reject_count || 0} ÂèçÂØπ)</small>
                                    <div class="mt-2">`;

                            if (voteAttempt.votes && Object.keys(voteAttempt.votes).length > 0) {
                                const sortedPlayerIds = Object.keys(voteAttempt.votes).sort((a, b) => parseInt(a) - parseInt(b));
                                sortedPlayerIds.forEach(playerId => {
                                    const vote = voteAttempt.votes[playerId];
                                    const playerInfo = getPlayerInfo(playerId);
                                    chatHtml += `
                                        <span class="vote-badge badge ${vote ? 'bg-success-light' : 'bg-danger-light'} border ${vote ? 'border-success' : 'border-danger'} text-dark">
                                            ${playerInfo.id}Âè∑: ${vote ? '<i class="bi bi-check-circle"></i> ËµûÊàê' : '<i class="bi bi-x-circle"></i> ÂèçÂØπ'}
                                        </span>

                                    `;
                                });
                            } else {
                                chatHtml += `<small class="text-muted d-block">ÔºàÊú™ËÆ∞ÂΩïÂÖ∑‰ΩìÊäïÁ•®Ôºâ</small>`;
                            }
                            chatHtml += `</div></div>`;
                        }
                        msgId++;
                    });
                }

                if (event.mission_execution) {
                    const execution = event.mission_execution;
                    const success = execution.success;
                    chatHtml += `
                        <div class="mission-result-info">
                            <div class="alert ${success ? 'alert-info' : 'alert-danger'} d-inline-block py-1 px-3">
                                <strong>‰ªªÂä° ${roundNum} ÊâßË°åÁªìÊûú:</strong>
                                ${success ? 'ÊàêÂäü' : 'Â§±Ë¥•'}
                                ${execution.fail_votes !== undefined ? ` (${execution.fail_votes} Á•®Â§±Ë¥•)` : ''}
                            </div>
                        </div>
                    `;
                }
                chatHtml += `<div class="clearfix"></div>`;
            });

            chatHtml += `
                <div class="round-divider">
                    <span class="badge bg-dark">Ê∏∏ÊàèÁªìÊùü</span>
                </div>
                <div class="message-system">
                    <div class="alert ${gameInfo.winner === 'blue' ? 'alert-info' : (gameInfo.winner === 'red' ? 'alert-danger' : 'alert-secondary')} d-inline-block fw-bold">
                        ${gameInfo.winner === 'blue' ? 'ËìùÊñπËÉúÂà©!' : (gameInfo.winner === 'red' ? 'Á∫¢ÊñπËÉúÂà©!' : 'Ê∏∏ÊàèÁªìÊùü')}
                    </div><br>
                    <small>ÂéüÂõ†: ${gameInfo.win_reason || 'Êú™Áü•'}</small><br>
                    <small>ÁªìÊùü‰∫é: ${gameInfo.end_time_formatted || 'Êú™Áü•Êó∂Èó¥'}</small>
                </div>
            `;

            chatContainer.innerHTML = chatHtml;
            scrollToBottom();
        }

        // --- Update Display for Round ---
        function updateDisplayForRound(round, shouldScroll = true) {
            let lastMoveIdx = -1;
            for (let i = 0; i <= moveSteps.length - 1; i++) {
                if (moveSteps[i].round == round) {
                    lastMoveIdx = i;
                    break;
                }
            }

            renderMapByMoveIndex(lastMoveIdx);

            if (shouldScroll) {
                const roundElement = document.getElementById(`round-${round}`);
                if (roundElement) {
                    const offsetTop = roundElement.offsetTop - chatContainer.offsetTop - 10;
                    chatContainer.scrollTo({ top: offsetTop, behavior: 'smooth' });
                } else if (round === 0) {
                    chatContainer.scrollTo({ top: 0, behavior: 'smooth' });
                } else if (round === 'assassination') {
                    const assassElement = document.getElementById(`round-assassination`);
                    if (assassElement) {
                        const offsetTop = assassElement.offsetTop - chatContainer.offsetTop - 10;
                        chatContainer.scrollTo({ top: offsetTop, behavior: 'smooth' });
                    }
                }
            }
        }

        // --- Event Listeners ---
        mapPrevRoundBtn.addEventListener('click', () => {
            if (currentMapRound > 0) {
                updateDisplayForRound(currentMapRound - 1, true);
            }
        });

        mapNextRoundBtn.addEventListener('click', () => {
            if (currentMapRound < maxRound) {
                updateDisplayForRound(currentMapRound + 1, true);
            }
        });

        scrollToBottomBtn.addEventListener('click', scrollToBottom);

        // Âú®‰∫ã‰ª∂ÁõëÂê¨Âô®ÈÉ®ÂàÜÊ∑ªÂä†
        const manualNextBtn = document.getElementById('manualNextBtn');

        if (manualNextBtn) {
            manualNextBtn.addEventListener('click', manualNextStep);
        }

        if (autoplayBtnFlow) {
            autoplayBtnFlow.addEventListener('click', () => {
                if (isAutoReplay) {
                    stopAutoReplay();
                } else {
                    startAutoReplay();
                }
            });
        }

        // ÂàùÂßãÂåñÂÜÖÂÆπ
        if (!gameInfo || !gameEvents || !playerMovements || mapSize <= 0) {
            chatContainer.innerHTML = `<div class="alert alert-danger m-3">ÈîôËØØÔºöÂä†ËΩΩÂØπÂ±ÄÊï∞ÊçÆÂ§±Ë¥•ÔºåÈÉ®ÂàÜ‰ø°ÊÅØÁº∫Â§±„ÄÇËØ∑Ê£ÄÊü•Êó•ÂøóÊñá‰ª∂„ÄÇ</div>`;
            console.error("Game data missing:", { gameInfo, gameEvents, playerMovements, mapSize });
        } else {
            generateChatHistory();
            updateDisplayForRound(0);
            
            // ÂàùÂßãÂåñÊâãÂä®ÊåâÈíÆÁä∂ÊÄÅ
            const messages = getAllReplayMessages();
            updateManualButtons(messages.length);
        }

        // TTSÂäüËÉΩÔºàÁÆÄÂåñÁâàÔºâ
        let currentAudio = null;
        let currentPlayingButton = null;

        window.playTTS = async function (speechId) {
            const speechElement = document.getElementById(speechId);
            if (!speechElement) return;

            const button = speechElement.querySelector('.tts-play-btn');
            if (!button) return;

            if (currentAudio && !currentAudio.paused) {
                currentAudio.pause();
                if (currentPlayingButton) {
                    setButtonState(currentPlayingButton, 'normal');
                }
            }

            const playerId = speechElement.dataset.playerId;
            const text = speechElement.dataset.text;
            const battleId = speechElement.dataset.battleId;

            if (!playerId || !text || !battleId) return;

            setButtonState(button, 'loading');

            try {
                const response = await fetch('/visualizer/api/tts/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        player_id: playerId,
                        battle_id: battleId,
                        roles: gameInfo.roles || {}
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.success && data.audio_url) {
                    await playAudioFromUrl(data.audio_url, button);
                } else {
                    throw new Error(data.error || 'ÁîüÊàêËØ≠Èü≥Â§±Ë¥•');
                }

            } catch (error) {
                console.error('TTSÊí≠ÊîæÂ§±Ë¥•:', error);
                setButtonState(button, 'error');
                setTimeout(() => setButtonState(button, 'normal'), 3000);
            }
        };

        async function playAudioFromUrl(audioUrl, button) {
            return new Promise((resolve, reject) => {
                const audio = new Audio(audioUrl);

                audio.addEventListener('canplay', () => {
                    setButtonState(button, 'playing');
                    currentAudio = audio;
                    currentPlayingButton = button;
                });

                audio.addEventListener('ended', () => {
                    setButtonState(button, 'normal');
                    currentAudio = null;
                    currentPlayingButton = null;
                    resolve();
                });

                audio.addEventListener('error', (e) => {
                    setButtonState(button, 'error');
                    setTimeout(() => setButtonState(button, 'normal'), 3000);
                    reject(new Error('Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•'));
                });

                audio.play().catch(reject);
            });
        }

        function setButtonState(button, state) {
            if (!button) return;

            button.classList.remove('loading', 'playing', 'error');
            button.disabled = false;

            const icon = button.querySelector('i');
            if (!icon) return;

            switch (state) {
                case 'loading':
                    button.classList.add('loading');
                    button.disabled = true;
                    icon.className = 'bi bi-hourglass-split';
                    break;
                case 'playing':
                    button.classList.add('playing');
                    icon.className = 'bi bi-pause-fill';
                    break;
                case 'error':
                    button.classList.add('error');
                    button.disabled = true;
                    icon.className = 'bi bi-exclamation-triangle';
                    break;
                default:
                case 'normal':
                    icon.className = 'bi bi-volume-up';
                    break;
            }
        }

        // Ê∑ªÂä†ÁßªÂä®Ê∂àÊÅØÁÇπÂáªÂ§ÑÁêÜÂáΩÊï∞
        window.showMoveOnMap = function (moveIndex) {
            renderMapByMoveIndex(moveIndex);

            // È´ò‰∫ÆÂØπÂ∫îÁöÑÁßªÂä®Ê∂àÊÅØ
            document.querySelectorAll('.move-message').forEach(msg => {
                msg.classList.remove('highlighted-move');
            });

            const clickedMsg = document.querySelector(`[data-move-index="${moveIndex}"]`);
            if (clickedMsg) {
                clickedMsg.classList.add('highlighted-move');
                setTimeout(() => {
                    clickedMsg.classList.remove('highlighted-move');
                }, 2000);
            }
        };

        // Ê∑ªÂä†Âà∫ÊùÄÊàêÂäüÂä®ÁîªÂáΩÊï∞
        function showAssassinationSuccessAnimation(assassinInfo, targetInfo, targetRole) {
            // ÂàõÂª∫Âä®ÁîªË¶ÜÁõñÂ±Ç
            const animationOverlay = document.createElement('div');
            animationOverlay.className = 'assassination-success-overlay';
            animationOverlay.innerHTML = `
                <div class="blood-effect"></div>
                <div class="dagger-icon">‚öîÔ∏è</div>
                <div class="victory-crown">üëë</div>
                
                <h1 class="assassination-title">Âà∫ÊùÄÊàêÂäü</h1>
                <h2 class="assassination-subtitle">Á∫¢ÊñπËÉúÂà©</h2>
                <div class="assassination-details">
                    <p><strong>Âà∫ÂÆ¢:</strong> ${assassinInfo.id}Âè∑ (${assassinInfo.name})</p>
                    <p><strong>ÁõÆÊ†á:</strong> ${targetInfo.id}Âè∑ (${targetInfo.name})</p>
                    <p><strong>Áî®Êà∑Âêç:</strong> ${getPlayerUsername(targetInfo.id)}</p>
                    <br>
                    <p style="font-style: italic; color: #ff6b6b;">
                        "Âú®ÈªëÊöó‰∏≠ÔºåÁúüÁõ∏Ë¢´Âà©ÂàÉÊè≠Èú≤Ôºå<br>
                        Ê¢ÖÊûóÁöÑÊô∫ÊÖß‰πüÊó†Ê≥ïÈÄÉËÑ±ÂëΩËøêÁöÑÂÆ°Âà§..."
                    </p>
                </div>
                
                <button class="close-animation-btn" onclick="closeAssassinationAnimation()">
                    <i class="bi bi-x-circle me-2"></i>ÂÖ≥Èó≠Âä®Áîª
                </button>
            `;
            
            document.body.appendChild(animationOverlay);
            
            // Ê∑ªÂä†Èü≥Êïà
            playAssassinationSound();
            
            // 10ÁßíÂêéËá™Âä®ÂÖ≥Èó≠
            setTimeout(() => {
                if (document.querySelector('.assassination-success-overlay')) {
                    closeAssassinationAnimation();
                }
            }, 10000);
        }

        // ÂÖ≥Èó≠Âà∫ÊùÄÂä®Áîª
        window.closeAssassinationAnimation = function() {
            const overlay = document.querySelector('.assassination-success-overlay');
            if (overlay) {
                overlay.style.animation = 'assassinationFadeOut 0.5s ease forwards';
                setTimeout(() => {
                    overlay.remove();
                }, 500);
            }
        };

        // Ëé∑ÂèñËßíËâ≤ÊòæÁ§∫ÂêçÁß∞
        function getRoleDisplayName(role) {
            const roleDisplayNames = {
                'Merlin': 'Ê¢ÖÊûó',
                'Percival': 'Ê¥æË•øÁª¥Â∞î',
                'Knight': 'È™ëÂ£´',
                'Assassin': 'Âà∫ÂÆ¢',
                'Morgana': 'Ëé´ÁîòÂ®ú',
                'Oberon': 'Â••‰ºØ‰º¶'
            };
            return roleDisplayNames[role] || role;
        }

        // Êí≠ÊîæËÉúÂà©Èü≥ÊïàÔºàÂèØÈÄâÔºâ
        function playAssassinationSound() {
            try {
                // ÂàõÂª∫Èü≥È¢ë‰∏ä‰∏ãÊñáÊí≠ÊîæÈü≥Êïà
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // ÂàõÂª∫‰∏Ä‰∏™ÁÆÄÂçïÁöÑÈü≥Êïà
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // ËÆæÁΩÆÈü≥ÊïàÂèÇÊï∞ - ‰ΩéÊ≤âÁöÑË≠¶ÂëäÈü≥
                oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.5);
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 1);
            } catch (error) {
                console.log('Èü≥ÊïàÊí≠ÊîæÂ§±Ë¥•:', error);
            }
        }

        // Ê∑ªÂä†Ëé∑ÂèñÁé©ÂÆ∂Áî®Êà∑ÂêçÁöÑÂáΩÊï∞
        function getPlayerUsername(playerId) {
            // ‰ªéÊ®°ÊùøÂèòÈáè‰∏≠Ëé∑ÂèñÁî®Êà∑ÂêçÊï∞ÁªÑ
            const playerUsernames = {{ player_usernames|tojson if player_usernames else 'null' }};
            
            if (playerUsernames && Array.isArray(playerUsernames)) {
                // playerId ÊòØ‰ªé1ÂºÄÂßãÁöÑÔºåÊï∞ÁªÑÁ¥¢Âºï‰ªé0ÂºÄÂßã
                const index = parseInt(playerId) - 1;
                if (index >= 0 && index < playerUsernames.length) {
                    return playerUsernames[index] || 'Êú™Áü•Áî®Êà∑';
                }
            }
            
            return 'Êú™Áü•Áî®Êà∑';
        }
    });
    </script>
{% endblock scripts %}
