{% extends "base.html" %}
{% block title %}
    对局重放 - {{ game_id }}
{% endblock title %}
{% block styles %}
    <link rel="stylesheet" href="../../static/css/medieval.css">
    {{ super() }}
    <style>
    /* 基础响应式设置 */
    :root {
        --sidebar-width: 300px;
        --chat-width: 600px;
    }

    @media (max-width: 768px) {
        :root {
            --sidebar-width: 100%;
            --chat-width: 100%;
        }
    }

    .navbar {
        background: none !important;
        background-image: url('../../static/images/wood-texture.png') !important;
        background-size: cover !important;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
        position: relative;
    }

    /* 移动端导航栏样式 */
    @media (max-width: 768px) {
        .navbar {
            padding: 0.5rem;
        }

        .navbar-brand {
            font-size: 1.2rem;
        }
    }

    /* 开场动画样式 */
    .intro-animation {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #222222;
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 1;
        transition: opacity 0.5s ease-out;
    }

    .intro-animation.fade-out {
        opacity: 0;
    }

    .intro-content {
        text-align: center;
        color: #fff;
        padding: 1rem;
    }

    .intro-title {
        font-size: clamp(2rem, 5vw, 3rem);
        color: #ffffff;
        margin-bottom: 1rem;
        opacity: 0;
        transform: translateY(20px);
        animation: fadeInUp 1s ease forwards;
    }

    .intro-subtitle {
        font-size: clamp(1rem, 3vw, 1.5rem);
        opacity: 0;
        transform: translateY(20px);
        animation: fadeInUp 1s ease 0.5s forwards;
    }

    .loading-bar {
        width: 200px;
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        margin: 2rem auto;
        border-radius: 2px;
        overflow: hidden;
        opacity: 0;
        animation: fadeIn 0.5s ease 0.5s forwards;
    }

    .loading-progress {
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, #4a90e2, #67b26f);
        animation: loading 2s ease 1s forwards;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes loading {
        from {
            width: 0%;
        }

        to {
            width: 100%;
        }
    }

    /* 聊天容器样式 */
    .chat-container {
        height: calc(100vh - 250px);
        overflow-y: auto;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        background-image: url('../../static/images/parchment-bg.png');
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center;
    }

    @media (max-width: 768px) {
        .chat-container {
            height: calc(100vh - 200px);
            padding: 0.5rem;
        }
    }

    /* 回合分隔线 */
    .round-divider {
        clear: both;
        text-align: center;
        margin: 25px 0 15px 0;
        position: relative;
    }

    .round-divider:before {
        content: "";
        position: absolute;
        left: 0;
        top: 50%;
        width: 100%;
        height: 1px;
        background-color: #dee2e6;
        z-index: 0;
    }

    .round-divider span {
        display: inline-block;
        padding: 5px 15px;
        background-color: #fff;
        position: relative;
        z-index: 1;
        font-weight: bold;
        border-radius: 15px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid #dee2e6;
    }

    /* 消息气泡基础样式 */
    .message-bubble {
        max-width: 100%;
        padding: 8px 12px;
        border-radius: 15px;
        position: relative;
        word-break: break-word;
        margin-bottom: 5px;
        display: inline-block;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 768px) {
        .message-bubble {
            padding: 6px 10px;
            font-size: 0.9rem;
        }
    }

    /* 蓝方消息 */
    .message-blue {
        background-color: rgb(190, 208, 235);
        border: 1px solid #9ec5fe;
        color: #052c65;
    }

    /* 红方消息 */
    .message-red {
        background-color: rgb(236, 207, 210);
        border: 1px solid #f5c2c7;
        color: #58151c;
    }

    /* 系统/中立消息 */
    .message-system {
        background-color: #e9ecef;
        border: 1px solid #ced4da;
        color: #495057;
        text-align: center;
        padding: 6px 10px;
        font-size: 0.9em;
        margin: 10px auto;
        display: block;
        clear: both;
    }

    /* 玩家标签样式 */
    .player-tag {
        font-size: 0.8rem;
        margin-bottom: 2px;
        font-weight: bold;
        padding: 0 5px;
        display: flex;
        align-items: center;
    }

    /* 消息包装器样式 */
    .message-wrapper {
        max-width: 80%;
        margin-bottom: 15px;
        position: relative;
        clear: both;
        display: flex;
        align-items: flex-end;
    }

    .message-wrapper-blue {
        float: left;
        margin-left: 5px;
        flex-direction: row;
    }

    .message-wrapper-red {
        float: right;
        margin-right: 5px;
        flex-direction: row-reverse;
    }

    .message-wrapper-blue .player-tag {
        text-align: left;
    }

    .message-wrapper-red .player-tag {
        text-align: right;
    }

    .message-content {
        flex: 1;
        min-width: 0;
    }

    /* 清除浮动 */
    .clearfix::after {
        content: "";
        clear: both;
        display: table;
    }

    /* 投票信息样式 */
    .vote-info {
        clear: both;
        text-align: center;
        margin: 15px 0;
        padding: 10px;
        background-color: #f8f9fa;
        border: 1px dashed #ced4da;
        border-radius: 5px;
    }

    .vote-badge {
        margin: 2px;
    }

    /* 任务结果样式 */
    .mission-result-info {
        clear: both;
        text-align: center;
        margin: 15px 0;
    }

    /* 侧边栏样式 */
    .sidebar {
        overflow-y: auto;
        max-height: calc(100vh - 100px);
    }

    h4,
    h5 {
        color: #ffffff;
        font-weight: bold;
    }

    /* 自动跳动回放高亮样式 */
    .auto-replay-active {
        background: #ffe082 !important;
        transition: background 0.3s;
        transform: scale(1.02);
        box-shadow: 0 2px 8px rgba(255, 224, 130, 0.5) !important;
    }

    /* 胜利横幅动画样式 */
    .victory-banner {
        position: fixed;
        top: 50%;
        left: -100%;
        width: 100%;
        height: auto;
        min-height: 100px;
        max-height: 80vh;
        padding: 20px 40px;
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        transform: translateY(-50%) rotate(-3deg);
        animation: victorySlideIn 1.5s ease-out forwards;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        overflow: hidden;
        border: 4px solid #ffd700;
        border-radius: 15px;
    }

    .victory-banner.blue {
        background: linear-gradient(45deg, #4A6B8A, #6A9BD2, #4A6B8A);
        background-size: 200% 200%;
        animation: victorySlideIn 1.5s ease-out forwards, blueShimmer 3s ease-in-out infinite;
        border-color: #4A6B8A;
        box-shadow: 0 0 20px rgba(74, 107, 138, 0.7), inset 0 0 20px rgba(135, 206, 235, 0.4);
    }

    .victory-banner.red {
        background: linear-gradient(45deg, #8B0000, #DC143C, #8B0000);
        background-size: 200% 200%;
        animation: victorySlideIn 1.5s ease-out forwards, redShimmer 3s ease-in-out infinite;
        border-color: #8B0000;
        box-shadow: 0 0 20px rgba(139, 0, 0, 0.7), inset 0 0 20px rgba(220, 20, 60, 0.4);
    }

    .victory-content {
        text-align: center;
        z-index: 2;
        position: relative;
        width: 100%;
        max-width: 80%;
        margin: 0 auto;
        padding: 0 1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #ffffff;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    }

    .victory-title {
        font-size: clamp(1.5rem, 4vw, 2.5rem);
        font-weight: bold;
        margin: 0 0 0.5rem 0;
        text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.7);
        color: #ffffff;
        opacity: 0;
        transform: scale(0.5);
        animation: victoryTitleAppear 1s ease 0.5s forwards;
        white-space: nowrap;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .victory-subtitle {
        font-size: clamp(0.9rem, 2vw, 1.2rem);
        margin: 0.3rem 0;
        color: rgba(255, 255, 255, 0.9);
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.6);
        opacity: 0;
        transform: translateY(20px);
        animation: victorySubtitleAppear 0.8s ease 1s forwards;
        white-space: nowrap;
    }

    .victory-reason {
        font-size: clamp(0.7rem, 1.5vw, 0.9rem);
        margin: 0.2rem 0 0 0;
        color: rgba(255, 255, 255, 0.8);
        font-style: italic;
        opacity: 0;
        transform: translateY(15px);
        animation: victoryReasonAppear 0.6s ease 1.5s forwards;
        max-width: 90%;
        text-align: center;
        line-height: 1.3;
        word-wrap: break-word;
    }

    .victory-particles {
        position: absolute;
        width: 100%;
        height: 100%;
        overflow: hidden;
        pointer-events: none;
        top: 0;
        left: 0;
    }

    .victory-particle {
        position: absolute;
        width: 6px;
        height: 6px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        animation: particleFall 3s linear infinite;
    }

    .victory-banner.blue .victory-particle {
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 0 4px rgba(106, 155, 210, 0.8);
    }

    .victory-banner.red .victory-particle {
        background: rgba(255, 215, 0, 0.9);
        box-shadow: 0 0 4px rgba(220, 20, 60, 0.8);
    }

    .victory-icon {
        position: absolute;
        font-size: clamp(1.5rem, 3vw, 2rem);
        opacity: 0;
        animation: victoryIconSpin 1.5s ease 2s forwards;
        color: rgba(255, 255, 255, 0.9);
    }

    .victory-icon.left {
        left: 10%;
        top: 50%;
        transform: translateY(-50%) rotate(-180deg) scale(0);
    }

    .victory-icon.right {
        right: 10%;
        top: 50%;
        transform: translateY(-50%) rotate(180deg) scale(0);
    }

    .victory-close-btn {
        position: absolute;
        top: 10px;
        right: 15px;
        background: rgba(0, 0, 0, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.7);
        color: rgba(255, 255, 255, 0.9);
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.1rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        opacity: 0;
        animation: victoryCloseAppear 0.5s ease 2.5s forwards;
        z-index: 10;
    }

    .victory-close-btn:hover {
        background: rgba(0, 0, 0, 0.6);
        border-color: #ffffff;
        color: #ffffff;
        transform: scale(1.1);
    }

    /* 移动端优化 */
    @media (max-width: 768px) {
        .victory-banner {
            height: auto;
            min-height: 80px;
            max-height: 70vh;
            padding: 15px 20px;
            transform: translateY(-50%) rotate(-2deg);
            border-radius: 10px;
        }

        .victory-content {
            padding: 0 0.5rem;
            max-width: 90%;
        }

        .victory-title {
            font-size: clamp(1.2rem, 5vw, 1.8rem);
            margin-bottom: 0.3rem;
            letter-spacing: 0.5px;
        }

        .victory-subtitle {
            font-size: clamp(0.8rem, 2.5vw, 1rem);
            margin: 0.2rem 0;
        }

        .victory-reason {
            font-size: clamp(0.65rem, 2vw, 0.8rem);
            margin: 0.2rem 0 0 0;
            max-width: 95%;
            line-height: 1.2;
        }

        .victory-icon {
            font-size: clamp(1.2rem, 4vw, 1.6rem);
        }

        .victory-icon.left {
            left: 8%;
        }

        .victory-icon.right {
            right: 8%;
        }

        .victory-close-btn {
            top: 8px;
            right: 12px;
            width: 28px;
            height: 28px;
            font-size: 1rem;
        }
    }

    /* 添加动画关键帧 */
    @keyframes victorySlideIn {
        0% {
            left: -100%;
            opacity: 0;
        }

        100% {
            left: 0;
            opacity: 1;
        }
    }

    @keyframes victorySlideOut {
        0% {
            left: 0;
            opacity: 1;
        }

        100% {
            left: 100%;
            opacity: 0;
        }
    }

    @keyframes victoryTitleAppear {
        0% {
            opacity: 0;
            transform: scale(0.5) translateY(20px);
        }

        100% {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    @keyframes victorySubtitleAppear {
        0% {
            opacity: 0;
            transform: translateY(20px);
        }

        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes victoryReasonAppear {
        0% {
            opacity: 0;
            transform: translateY(15px);
        }

        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes victoryIconSpin {
        0% {
            opacity: 0;
            transform: translateY(-50%) rotate(-180deg) scale(0);
        }

        100% {
            opacity: 1;
            transform: translateY(-50%) rotate(0deg) scale(1);
        }
    }

    @keyframes victoryCloseAppear {
        0% {
            opacity: 0;
            transform: scale(0.5);
        }

        100% {
            opacity: 1;
            transform: scale(1);
        }
    }

    @keyframes particleFall {
        0% {
            opacity: 0;
            top: -10px;
        }

        10% {
            opacity: 1;
        }

        90% {
            opacity: 1;
        }

        100% {
            opacity: 0;
            top: 110%;
        }
    }

    @keyframes blueShimmer {

        0%,
        100% {
            background-position: 0% 50%;
        }

        50% {
            background-position: 100% 50%;
        }
    }

    @keyframes redShimmer {

        0%,
        100% {
            background-position: 0% 50%;
        }

        50% {
            background-position: 100% 50%;
        }
    }

    /* 聊天记录滚动条样式 */
    .chat-container::-webkit-scrollbar {
        width: 8px;
        background-color: #f1f1f1;
    }

    .chat-container::-webkit-scrollbar-thumb {
        border-radius: 10px;
        background-color: #007bff;
    }

    .chat-container::-webkit-scrollbar-thumb:hover {
        background-color: #0056b3;
    }

    /* 响应式布局调整 */
    @media (max-width: 768px) {
        .container-fluid {
            padding: 0.5rem;
        }

        .row {
            margin: 0;
        }

        .col-lg-3,
        .col-lg-6,
        .col-md-4,
        .col-md-8 {
            padding: 0.5rem;
        }

        .card {
            margin-bottom: 0.5rem;
        }

        .card-body {
            padding: 0.5rem;
        }

        .table {
            font-size: 0.8rem;
        }

        .btn-group {
            width: 100%;
        }

        .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .sidebar {
            max-height: none;
            overflow-y: visible;
        }

        .vote-info {
            padding: 0.5rem;
            margin: 0.5rem 0;
        }

        .vote-badge {
            font-size: 0.7rem;
            margin: 1px;
        }

        .message-wrapper {
            max-width: 90%;
        }

        .player-tag {
            font-size: 0.7rem;
        }

        .card-footer {
            padding: 0.5rem;
        }

        .card-footer .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        #mainView .row {
            margin: 0;
        }

        #mainView .col-lg-8,
        #mainView .col-lg-4 {
            padding: 0.5rem;
        }

        #mainView .card {
            margin-bottom: 0.5rem;
        }
    }
    </style>
{% endblock styles %}
{% block content %}
    <!-- 开场动画 -->
    <div class="intro-animation" id="introAnimation">
        <div class="intro-content">
            <h1 class="intro-title">阿瓦隆</h1>
            <p class="intro-subtitle">对局重放</p>
            <div class="loading-bar">
                <div class="loading-progress"></div>
            </div>
        </div>
    </div>
    <!-- 移动端导航切换按钮 -->
    <div class="d-lg-none mb-2">
        <div class="btn-group w-100" role="group">
            <button type="button" class="btn btn-outline-primary active" data-view="main">游戏进程</button>
            <button type="button" class="btn btn-outline-primary" data-view="info">游戏信息</button>
        </div>
    </div>
    <div class="container-fluid mt-3">
        <div class="row">
            <!-- 左侧边栏：游戏信息和角色列表 -->
            <div class="col-lg-3 col-md-4 mobile-view" id="infoView">
                <div class="sidebar">
                    <!-- 游戏信息卡片 -->
                    <div class="card shadow-sm mb-3">
                        <div class="card-header bg-primary text-white py-2">
                            <h5 class="mb-0 fs-6">对局信息</h5>
                        </div>
                        <div class="card-body p-2">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center py-1 px-0">
                                    <small>游戏ID</small>
                                    <span class="badge bg-secondary rounded-pill">{{ game_id }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center py-1 px-0">
                                    <small>状态</small>
                                    <span class="badge rounded-pill {% if game_info.winner == 'blue' %}bg-info text-dark{% elif game_info.winner == 'red' %}bg-danger{% else %}bg-secondary{% endif %}">
                                        {{ "蓝方胜利" if game_info.winner == "blue" else ("红方胜利" if game_info.winner == "red"
                                        else "未结束") }}
                                    </span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center py-1 px-0">
                                    <small>原因</small>
                                    <small class="text-muted text-end">{{ game_info.win_reason | truncate(30) if
                                    game_info.win_reason else '未知' }}</small>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <!-- 角色列表 -->
                    <div class="card shadow-sm mb-3">
                        <div class="card-header bg-primary text-white py-2">
                            <h5 class="mb-0 fs-6">
                                角色列表 ({{ game_info.player_count if game_info.player_count else
                                game_info.roles|length }}人)
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm table-striped table-bordered mb-0 small">
                                    <thead class="table-light">
                                        <tr>
                                            <th>玩家</th>
                                            <th>用户名</th>
                                            <th>角色</th>
                                            <th>阵营</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for player_id, role in game_info.roles.items() | sort %}
                                            {% set player_id_str = player_id | string %}
                                            <tr>
                                                <td class="text-center">{{ player_id_str }}</td>
                                                {% if player_usernames %}
                                                    <td>
                                                        {{ player_usernames[player_id|int - 1] if player_usernames|length >=
                                                        player_id|int else '未知' }}
                                                    </td>
                                                {% else %}
                                                    <td>未知</td>
                                                {% endif %}
                                                <td>
                                                    {% set is_blue = role in ["Merlin", "Percival", "Knight"] %}
                                                    {% if role == "Merlin" %}
                                                        梅林
                                                    {% elif role == "Percival" %}
                                                        派西维尔
                                                    {% elif role == "Knight" %}
                                                        骑士
                                                    {% elif role == "Assassin" %}
                                                        刺客
                                                    {% elif role == "Morgana" %}
                                                        莫甘娜
                                                    {% elif role == "Mordred" %}
                                                        莫德雷德
                                                    {% elif role == "Oberon" %}
                                                        奥伯伦
                                                    {% else %}
                                                        {{ role }}
                                                    {% endif %}
                                                </td>
                                                <td class="text-center">
                                                    {% if is_blue %}
                                                        <span class="badge bg-info text-dark">蓝方</span>
                                                    {% else %}
                                                        <span class="badge bg-danger">红方</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% else %}
                                            <tr>
                                                <td colspan="4" class="text-center text-muted">角色信息不可用</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 中央：聊天记录主体 -->
            <div class="col-lg-9 col-md-8 mobile-view" id="mainView">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white py-2 d-flex justify-content-between align-items-center">
                        <h4 class="mb-0 fs-6">对局流程</h4>
                        <span class="badge bg-light text-dark" id="currentRoundBadge">初始状态</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="chat-container" id="chatContainer">
                            <!-- 初始化提示 -->
                            <div class="text-center my-5 text-muted">
                                <i class="bi bi-hourglass-split" style="font-size: 2rem;"></i>
                                <p>加载对局流程中...</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">自动跳动回放</small>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary"
                                        id="scrollToBottomBtn"
                                        title="滚动到底部">
                                    <i class="bi bi-arrow-down-circle"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info ms-1"
                                        id="manualNextBtn"
                                        title="手动下一步">
                                    <i class="bi bi-skip-end-fill"></i>
                                </button>
                                <button type="button"
                                        class="btn btn-sm btn-outline-primary ms-2"
                                        id="autoplayBtnFlow">
                                    <i class="bi bi-play-fill"></i> 自动播放
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}
{% block scripts %}
    {{ super() }}
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- 自动逐条跳动回放 ---
        let isAutoReplay = false;
        let autoReplayTimeout = null;
        let currentReplayMsgIndex = 0;

        // DOM Elements
        const chatContainer = document.getElementById('chatContainer');
        const currentRoundBadge = document.getElementById('currentRoundBadge');
        const autoplayBtnFlow = document.getElementById('autoplayBtnFlow');
        const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');
        const manualNextBtn = document.getElementById('manualNextBtn');

        // --- Data from Flask ---
        const gameEvents = {{ game_events| tojson
    }};
    const gameInfo = {{ game_info| tojson }};
    const roles = gameInfo.roles || {};
    const gameId = "{{ game_id }}";

    const roleNames = {
        "Merlin": "梅林", "Percival": "派西维尔", "Knight1": "骑士", "Knight2": "骑士",
        "Assassin": "刺客", "Morgana": "莫甘娜", "Oberon": "奥伯伦"
    };
    const roleFactions = {
        "Merlin": "blue", "Percival": "blue", "Knight1": "blue", "Knight2": "blue",
        "Assassin": "red", "Morgana": "red", "Oberon": "red"
    };

    let knightCount = 0;
    const knightAssignments = new Map();

    function getAllReplayMessages() {
        return Array.from(chatContainer.querySelectorAll('.message-bubble, .message-system'));
    }

    function getMessageDelay(msgElem) {
        let text = '';
        let baseDelay = 1000;

        if (msgElem.classList.contains('message-bubble')) {
            text = msgElem.innerText || msgElem.textContent || '';
            baseDelay = 1500;
        } else if (msgElem.classList.contains('message-system')) {
            text = msgElem.innerText || msgElem.textContent || '';
            baseDelay = 800;
        }

        const chineseChars = (text.match(/[\u4e00-\u9fa5]/g) || []).length;
        const otherChars = text.length - chineseChars;

        const chineseReadTime = chineseChars * 120;
        const otherReadTime = otherChars * 40;

        let totalDelay = baseDelay + chineseReadTime + otherReadTime;

        if (msgElem.classList.contains('message-bubble')) {
            totalDelay = Math.max(1500, Math.min(6000, totalDelay));
        } else if (msgElem.classList.contains('message-system')) {
            totalDelay = Math.max(800, Math.min(4000, totalDelay));
        } else {
            totalDelay = Math.max(500, Math.min(5000, totalDelay));
        }

        return totalDelay;
    }

    function manualNextStep() {
        const messages = getAllReplayMessages();
        if (currentReplayMsgIndex >= messages.length) {
            currentReplayMsgIndex = messages.length - 1;
            return;
        }

        if (isAutoReplay) {
            stopAutoReplay();
        }

        executeReplayStep(messages);
        currentReplayMsgIndex++;

        updateManualButtons(messages.length);
    }

    function executeReplayStep(messages) {
        if (currentReplayMsgIndex >= messages.length) {
            return false;
        }

        const msg = messages[currentReplayMsgIndex];

        msg.scrollIntoView({ behavior: 'smooth', block: 'center' });

        messages.forEach(m => m.classList.remove('auto-replay-active'));
        msg.classList.add('auto-replay-active');

        checkForVictory(msg);

        return true;
    }

    function checkForVictory(msgElement) {
        const text = msgElement.textContent || msgElement.innerText || '';

        if (text.includes('胜利')) {
            setTimeout(function () {
                if (text.includes('蓝方胜利')) {
                    showVictoryBanner('blue', '🔵 蓝方胜利', '正义与智慧的胜利', gameInfo.win_reason);
                } else if (text.includes('红方胜利')) {
                    showVictoryBanner('red', '🔴 红方胜利', '阴谋与背叛的胜利', gameInfo.win_reason);
                }
            }, 800);
        }
    }

    function showVictoryBanner(faction, title, subtitle, reason) {
        const existingBanner = document.querySelector('.victory-banner');
        if (existingBanner) {
            existingBanner.remove();
        }

        const victoryBanner = document.createElement('div');
        victoryBanner.className = 'victory-banner ' + faction;

        let particlesHtml = '';
        for (let i = 0; i < 15; i++) {
            const left = Math.random() * 100;
            const delay = Math.random() * 2;
            particlesHtml += '<div class="victory-particle" style="left: ' + left + '%; animation-delay: ' + delay + 's;"></div>';
        }

        let html = '<div class="victory-particles">' + particlesHtml + '</div>';
        html += '<div class="victory-icon left">⚔️</div>';
        html += '<div class="victory-icon right">🏆</div>';
        html += '<div class="victory-content">';
        html += '<h1 class="victory-title">' + title + '</h1>';
        html += '<p class="victory-subtitle">' + subtitle + '</p>';
        html += '<p class="victory-reason">' + (reason || '游戏结束') + '</p>';
        html += '</div>';

        const closeBtn = document.createElement('button');
        closeBtn.className = 'victory-close-btn';
        closeBtn.innerHTML = '✕';
        closeBtn.title = '关闭';
        closeBtn.style.opacity = '0';
        closeBtn.style.animation = 'victoryCloseAppear 0.5s ease 2.5s forwards';

        closeBtn.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            closeVictoryBanner();
        });

        victoryBanner.innerHTML = html;
        victoryBanner.appendChild(closeBtn);

        victoryBanner.addEventListener('click', function (e) {
            if (e.target === victoryBanner) {
                closeVictoryBanner();
            }
        });

        document.body.appendChild(victoryBanner);

        setTimeout(function () {
            if (document.querySelector('.victory-banner')) {
                closeVictoryBanner();
            }
        }, 8000);
    }

    function closeVictoryBanner() {
        const banner = document.querySelector('.victory-banner');
        if (banner) {
            banner.style.animation = 'victorySlideOut 0.8s ease forwards';
            setTimeout(() => {
                banner.remove();
            }, 800);
        }
    }

    window.closeVictoryBanner = closeVictoryBanner;

    function startAutoReplay() {
        if (isAutoReplay) return;

        isAutoReplay = true;
        autoplayBtnFlow.innerHTML = '<i class="bi bi-pause-fill"></i> 暂停播放';
        autoplayBtnFlow.classList.remove('btn-outline-primary');
        autoplayBtnFlow.classList.add('btn-primary');

        const messages = getAllReplayMessages();
        if (currentReplayMsgIndex >= messages.length) {
            currentReplayMsgIndex = 0;
        }

        playNextMessage(messages);
    }

    function stopAutoReplay() {
        if (!isAutoReplay) return;

        isAutoReplay = false;
        if (autoReplayTimeout) {
            clearTimeout(autoReplayTimeout);
            autoReplayTimeout = null;
        }

        autoplayBtnFlow.innerHTML = '<i class="bi bi-play-fill"></i> 自动播放';
        autoplayBtnFlow.classList.remove('btn-primary');
        autoplayBtnFlow.classList.add('btn-outline-primary');
    }

    function playNextMessage(messages) {
        if (!isAutoReplay || currentReplayMsgIndex >= messages.length) {
            stopAutoReplay();
            return;
        }

        const success = executeReplayStep(messages);
        if (!success) {
            stopAutoReplay();
            return;
        }

        const currentMsg = messages[currentReplayMsgIndex];
        const delay = getMessageDelay(currentMsg);

        currentReplayMsgIndex++;
        updateManualButtons(messages.length);

        autoReplayTimeout = setTimeout(() => {
            playNextMessage(messages);
        }, delay);
    }

    function updateManualButtons(totalMessages) {
        if (manualNextBtn) {
            if (currentReplayMsgIndex >= totalMessages) {
                manualNextBtn.disabled = true;
                manualNextBtn.innerHTML = '<i class="bi bi-check-circle"></i> 已完成';
            } else {
                manualNextBtn.disabled = false;
                manualNextBtn.innerHTML = '<i class="bi bi-skip-end-fill"></i> 下一步';
            }
        }
    }

    function getPlayerInfo(playerId) {
        const idStr = String(playerId);
        let role = roles[idStr] || '未知角色';
        if (role === 'Knight') {
            if (!knightAssignments.has(idStr)) {
                knightCount++;
                knightAssignments.set(idStr, knightCount);
            }
            role = knightAssignments.get(idStr) === 1 ? 'Knight1' : 'Knight2';
        }
        const name = roleNames[role] || role;
        const faction = roleFactions[role] || 'unknown';
        return { id: idStr, role: role, name: name, faction: faction };
    }

    function scrollToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function initializeKnightAssignments() {
        knightCount = 0;
        knightAssignments.clear();
        const knightIds = Object.entries(roles)
            .filter(([_, role]) => role === 'Knight')
            .map(([id, _]) => parseInt(id))
            .sort((a, b) => a - b);

        knightIds.forEach((id, index) => {
            knightAssignments.set(id.toString(), index + 1);
        });
    }

    initializeKnightAssignments();

    function generateChatHistory() {
        let chatHtml = '';
        let msgId = 0;

        chatHtml += `
        <div class="round-divider" id="round-0">
          <span class="badge bg-secondary">游戏开始</span>
        </div>
      `;

        gameEvents.forEach((event) => {
            if (event.round === 'assassination') {
                chatHtml += `
            <div class="round-divider" id="round-assassination">
              <span class="badge bg-dark">刺杀阶段</span>
            </div>`;
                if (event.assassination) {
                    const assassinInfo = getPlayerInfo(event.assassination.assassin);
                    const targetInfo = getPlayerInfo(event.assassination.target);
                    chatHtml += `
              <div class="message-system">
                刺客 ${assassinInfo.id}号 (${assassinInfo.name}) 选择刺杀 ${targetInfo.id}号 (${targetInfo.name} - ${event.assassination.target_role}).<br>
                结果: <span class="badge ${event.assassination.success ? 'bg-danger' : 'bg-success'}">${event.assassination.success ? '成功' : '失败'}</span>
              </div>`;
                }
                return;
            }

            const roundNum = event.round;

            chatHtml += `
          <div class="round-divider" id="round-${roundNum}">
            <span class="badge bg-secondary">第 ${roundNum} 轮任务</span>
          </div>
        `;

            if (event.leader) {
                const leaderInfo = getPlayerInfo(event.leader);
                chatHtml += `
            <div class="message-system">
              <i class="bi bi-person-badge"></i> <strong>队长:</strong> ${leaderInfo.id}号 (${leaderInfo.name})<br>
              <i class="bi bi-people-fill"></i> <strong>提议队伍:</strong>
              ${event.team_members && event.team_members.length > 0
                        ? event.team_members.map(memberId => `<span class="badge bg-secondary mx-1">${getPlayerInfo(memberId).id}号</span>`).join('')
                        : '无'}
            </div>
          `;
            }

            if (event.events && event.events.length > 0) {
                event.events.forEach(eventItem => {
                    if (eventItem.type === "speech") {
                        const [playerId, message, speechType, hearers] = eventItem.data;

                        // 跳过有限范围发言
                        if (speechType === "private") {
                            return;
                        }

                        const playerInfo = getPlayerInfo(playerId);
                        const wrapperClass = playerInfo.faction === 'blue' ? 'message-wrapper-blue' : 'message-wrapper-red';
                        const bubbleClass = playerInfo.faction === 'blue' ? 'message-blue' : 'message-red';

                        chatHtml += `
                <div class="message-wrapper ${wrapperClass}">
                  <div class="message-content">
                    <div class="player-tag">
                      ${playerInfo.id}号 <span class="badge bg-info text-dark speech-badge">公开</span>                    
                    </div>
                    <div class="message-bubble ${bubbleClass}">
                      ${message}
                    </div>
                  </div>
                </div>
                <div class="clearfix"></div>
              `;
                    } else if (eventItem.type === "vote_attempt") {
                        const voteAttempt = eventItem.data;
                        const approved = voteAttempt.approved;
                        chatHtml += `
                <div class="vote-info">
                  <strong>队伍投票结果:</strong>
                  <span class="badge fs-6 ${approved ? 'bg-success' : 'bg-warning text-dark'}">
                    ${approved ? '通过' : '拒绝'}
                  </span>
                  <small class="text-muted">(${voteAttempt.approve_count || 0} 赞成 / ${voteAttempt.reject_count || 0} 反对)</small>
                </div>`;
                    }
                    msgId++;
                });
            }

            if (event.mission_execution) {
                const execution = event.mission_execution;
                const success = execution.success;
                chatHtml += `
            <div class="mission-result-info">
              <div class="alert ${success ? 'alert-info' : 'alert-danger'} d-inline-block py-1 px-3">
                <strong>任务 ${roundNum} 执行结果:</strong>
                ${success ? '成功' : '失败'}
                ${execution.fail_votes !== undefined ? ` (${execution.fail_votes} 票失败)` : ''}
              </div>
            </div>
          `;
            }
            chatHtml += `<div class="clearfix"></div>`;
        });

        chatHtml += `
        <div class="round-divider">
          <span class="badge bg-dark">游戏结束</span>
        </div>
        <div class="message-system">
          <div class="alert ${gameInfo.winner === 'blue' ? 'alert-info' : (gameInfo.winner === 'red' ? 'alert-danger' : 'alert-secondary')} d-inline-block fw-bold">
            ${gameInfo.winner === 'blue' ? '蓝方胜利!' : (gameInfo.winner === 'red' ? '红方胜利!' : '游戏结束')}
          </div><br>
          <small>原因: ${gameInfo.win_reason || '未知'}</small><br>
        </div>
      `;

        chatContainer.innerHTML = chatHtml;
        scrollToBottom();
    }

    // 移动端视图切换
    const viewButtons = document.querySelectorAll('[data-view]');
    const views = document.querySelectorAll('.mobile-view');

    function switchView(viewName) {
        views.forEach(view => {
            if (view.id === viewName + 'View') {
                view.style.display = 'block';
            } else {
                view.style.display = 'none';
            }
        });

        viewButtons.forEach(btn => {
            if (btn.dataset.view === viewName) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }

    viewButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            switchView(btn.dataset.view);
        });
    });

    // 初始化
    if (window.innerWidth <= 768) {
        switchView('main');
    }

    window.addEventListener('resize', () => {
        if (window.innerWidth > 768) {
            views.forEach(view => {
                view.style.display = '';
            });
        }
    });

    // 开场动画
    setTimeout(() => {
        const introAnimation = document.getElementById('introAnimation');
        if (introAnimation) {
            introAnimation.classList.add('fade-out');
            setTimeout(() => {
                introAnimation.style.display = 'none';
            }, 500);
        }
    }, 3000);

    // 事件监听器
    if (scrollToBottomBtn) {
        scrollToBottomBtn.addEventListener('click', scrollToBottom);
    }

    if (manualNextBtn) {
        manualNextBtn.addEventListener('click', manualNextStep);
    }

    if (autoplayBtnFlow) {
        autoplayBtnFlow.addEventListener('click', () => {
            if (isAutoReplay) {
                stopAutoReplay();
            } else {
                startAutoReplay();
            }
        });
    }

    // 初始化内容
    if (!gameInfo || !gameEvents) {
        chatContainer.innerHTML = `<div class="alert alert-danger m-3">错误：加载对局数据失败，部分信息缺失。请检查日志文件。</div>`;
        console.error("Game data missing:", { gameInfo, gameEvents });
    } else {
        generateChatHistory();

        // 初始化手动按钮状态
        const messages = getAllReplayMessages();
        updateManualButtons(messages.length);
    }
  });
    </script>
{% endblock scripts %}
